# TypeScript/Node.js Docker Compose Template
# Generated by AI Fabrix Builder SDK
# Service definition for local development

services:
  {{app.key}}:
    image: {{image.name}}:{{image.tag}}
    container_name: {{containerName}}
    env_file:
      - {{envFile}}
    ports:
      - "{{hostPort}}:{{containerPort}}"
    networks:
      - {{networkName}}
    {{#if requiresStorage}}
    volumes:
      - "{{mountVolume}}:/mnt/data"
    {{/if}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{port}}{{healthCheck.path}}"]
      interval: {{healthCheck.interval}}s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    {{#if requiresDatabase}}
    depends_on:
      db-init:
        condition: service_completed_successfully
    {{/if}}

  {{#if requiresDatabase}}
  # Database Initialization
  db-init:
    image: pgvector/pgvector:pg15
    container_name: {{containerName}}-db-init
    env_file:
      - ${ADMIN_SECRETS_PATH}
      - {{envFile}}
    environment:
      POSTGRES_DB: postgres
      PGHOST: postgres
      PGPORT: "5432"
      PGUSER: pgadmin
      {{#if databases}}
      {{#each databases}}
      DB_{{@index}}_PASSWORD: {{lookup ../databasePasswords.array @index}}
      {{/each}}
      {{else}}
      DB_PASSWORD: {{lookup databasePasswords.array 0}}
      {{/if}}
    networks:
      - {{networkName}}
    command: >
      sh -c "
        export PGHOST=postgres PGPORT=5432 PGUSER=pgadmin &&
        export PGPASSWORD=\"${POSTGRES_PASSWORD}\" &&
        echo 'Waiting for PostgreSQL to be ready...' &&
        counter=0 &&
        while [ ${counter:-0} -lt 30 ]; do
          if pg_isready -h postgres -p 5432 -U pgadmin >/dev/null 2>&1; then
            echo 'PostgreSQL is ready!'
            break
          fi
          echo 'Waiting for PostgreSQL...'
          sleep 1
          counter=$((${counter:-0} + 1))
        done &&
        {{#if databases}}
        {{#each databases}}
        echo 'Creating {{name}} database and user...' &&
        if psql -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname = '{{name}}'\" 2>/dev/null | grep -q '^1$'; then
          echo 'Database \\\"{{name}}\\\" already exists, all ok.'
        else
          (psql -d postgres -c \"CREATE DATABASE \\\"{{name}}\\\";\" || true) &&
          (psql -d postgres -c \"DROP USER IF EXISTS \\\"{{pgUserOld name}}\\\";\" || true) &&
          (psql -d postgres -c \"CREATE USER {{pgUser name}} WITH PASSWORD '${DB_{{@index}}_PASSWORD}';\" || true) &&
          psql -d postgres -c \"GRANT ALL PRIVILEGES ON DATABASE \\\"{{name}}\\\" TO {{pgUser name}};\" || true &&
          psql -d {{name}} -c \"ALTER SCHEMA public OWNER TO {{pgUser name}};\" || true &&
          psql -d {{name}} -c \"GRANT ALL ON SCHEMA public TO {{pgUser name}};\" || true
        fi &&
        {{/each}}
        {{else}}
        echo 'Creating {{app.key}} database and user...' &&
        if psql -d postgres -tAc \"SELECT 1 FROM pg_database WHERE datname = '{{app.key}}'\" 2>/dev/null | grep -q '^1$'; then
          echo 'Database \\\"{{app.key}}\\\" already exists, all ok.'
        else
          (psql -d postgres -c \"CREATE DATABASE \\\"{{app.key}}\\\";\" || true) &&
          (psql -d postgres -c \"DROP USER IF EXISTS \\\"{{pgUserOld app.key}}\\\";\" || true) &&
          (psql -d postgres -c \"CREATE USER {{pgUser app.key}} WITH PASSWORD '${DB_0_PASSWORD:-${DB_PASSWORD}}';\" || true) &&
          psql -d postgres -c \"GRANT ALL PRIVILEGES ON DATABASE \\\"{{app.key}}\\\" TO {{pgUser app.key}};\" || true &&
          psql -d {{app.key}} -c \"ALTER SCHEMA public OWNER TO {{pgUser app.key}};\" || true &&
          psql -d {{app.key}} -c \"GRANT ALL ON SCHEMA public TO {{pgUser app.key}};\" || true
        fi &&
        {{/if}}
        echo 'Database initialization complete!'
      "
    restart: "no"
  {{/if}}

networks:
  {{networkName}}:
    external: true
