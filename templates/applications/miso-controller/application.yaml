# Application Metadata
app:
  key: miso-controller
  displayName: 'Miso Controller'
  description: 'Miso is the AI Fabrix in-tenant controller and portal layer for securely operating enterprise AI apps inside a customer’s Azure tenant. It provides Entra ID SSO, RBAC, audit logs, environment/app configuration via schemas, and safe secret handling via Key Vault references—ensuring governance, traceability, and predictable UX across portal, SDK, and CLI.'
  type: webapp
  version: '1.8.0'

# Image Configuration
image:
  name: aifabrix/miso-controller
  registry: aifabrixdevacr.azurecr.io
  registryMode: acr

# Port Configuration (container port; host port = 3000 + developer_id*100 from ~/.aifabrix/config.yaml)
port: 3000

# Azure Requirements
requires:
  database: true
  databases:
    - name: miso
    - name: miso-logs
  redis: true
  storage: true

# Health Check
healthCheck:
  path: /health
  interval: 30
  probePath: /health
  probeRequestType: GET
  probeProtocol: Https
  probeIntervalInSeconds: 120

# Authentication
authentication:
  type: keycloak
  enableSSO: true
  requiredRoles:
    - aifabrix-user

# Build Configuration
build:
  context: ../.. # Docker build context (relative to builder/miso-controller/)
  dockerfile: builder/miso-controller/Dockerfile # Dockerfile name (relative to project root)
  envOutputPath: ../../packages/miso-controller/.env # Copy .env to repo root for local dev (relative to builder/) (if null, no .env file is copied) (if empty, .env file is copied to repo root)
  localPort: 3010 # Port for local development (different from Docker port)
  language: typescript # Runtime language for template selection (typescript or python)

# =============================================================================
# Portal Input Configuration (Deployment Wizard)
# =============================================================================
# User-editable parameters only. No system URLs, credentials, or secrets.
#
# NOT included (auto-configured):
# - DATABASE_URL, REDIS_URL, KEYCLOAK_* → auto-generated during Azure install
# - MISO_*, AZURE_*, kv:// → credentials and system parameters
# - PORT, NODE_ENV, MISO_ENVIRONMENT → set by deployment target

configuration:
  # -------------------------------------------------------------------------
  # Operations & Debugging
  # -------------------------------------------------------------------------
  - name: LOG_LEVEL
    portalInput:
      field: select
      label: 'Log Level'
      options:
        - debug
        - info
        - warn
        - error

  - name: ENABLE_API_DOCS
    portalInput:
      field: select
      label: 'Enable API Documentation (Swagger/ReDoc)'
      options:
        - 'true'
        - 'false'

  - name: FAST_STARTUP
    portalInput:
      field: select
      label: 'Fast Startup (skip non-critical init)'
      options:
        - 'true'
        - 'false'

  - name: LOG_TO_FILE
    portalInput:
      field: select
      label: 'Log to File'
      options:
        - 'true'
        - 'false'

  # -------------------------------------------------------------------------
  # Keycloak Events (feature flag)
  # -------------------------------------------------------------------------
  - name: KEYCLOAK_EVENTS_ENABLED
    portalInput:
      field: select
      label: 'Keycloak Events (sync users/groups)'
      options:
        - 'true'
        - 'false'

  # -------------------------------------------------------------------------
  # Rate Limiting (tune for environment)
  # -------------------------------------------------------------------------
  - name: RATE_LIMIT_WINDOW_MS
    portalInput:
      field: text
      label: 'Rate Limit Window (milliseconds)'
      placeholder: '900000'

  - name: RATE_LIMIT_MAX
    portalInput:
      field: text
      label: 'Rate Limit Max Requests per Window'
      placeholder: '100'

  # -------------------------------------------------------------------------
  # Redis Cache TTL (seconds) – RBAC/roles caching
  # -------------------------------------------------------------------------
  - name: REDIS_ROLES_TTL
    portalInput:
      field: text
      label: 'Redis Roles Cache TTL (seconds)'
      placeholder: '900'

  - name: REDIS_PERMISSIONS_TTL
    portalInput:
      field: text
      label: 'Redis Permissions Cache TTL (seconds)'
      placeholder: '900'
