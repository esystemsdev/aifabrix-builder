# {{displayName}} Builder

Build, run, and deploy {{displayName}} using `@aifabrix/builder`.

---

## Quick Start

### 1. Install

```bash
npm install -g @aifabrix/builder
```

### 2. First Time Setup

```bash
# Check your environment
aifabrix doctor

# Login to controller (offline tokens are default; sets controller and environment in config)
aifabrix login --controller http://localhost:3000

# Register your application (gets you credentials; uses controller and environment from config)
aifabrix app register {{appName}}
```

### 3. Build & Run Locally

```bash
# Build the Docker image
aifabrix build {{appName}}

# Generate environment variables
aifabrix resolve {{appName}}

# Run locally
aifabrix run {{appName}}
```

**Access your app:** http://localhost:{{port}}

**View logs:**
```bash
aifabrix logs {{appName}}
```

**Stop:**
```bash
aifabrix down-app {{appName}}
# aifabrix down-app {{appName}} --volumes   # also remove data volume
```

### 4. Deploy to Azure

```bash
# Build with version tag
aifabrix build {{appName}} --tag v1.0.0

# Push to registry
aifabrix push {{appName}} --registry {{registry}} --tag "v1.0.0,latest"

# Deploy (controller and environment from config; set via aifabrix login or aifabrix auth config)
aifabrix deploy {{appName}} --local
```

---

## Using miso-client

> [miso-client](https://github.com/esystemsdev/aifabrix-miso-client)

After registering your app, you automatically get credentials in your secret file. Use miso-client for login, RBAC, audit logs, etc.

**Rotate credentials if needed:**
```bash
aifabrix app rotate-secret {{appName}}
```

---

## Reference

### Common Commands

```bash
# Development
aifabrix build {{appName}}                        # Build app
aifabrix run {{appName}}                          # Run locally
aifabrix down-app {{appName}} [--volumes]         # Stop app (optionally remove volume)
aifabrix dockerfile {{appName}} --force           # Generate Dockerfile
aifabrix resolve {{appName}}                      # Generate .env file

# Deployment
aifabrix json {{appName}}                         # Generate deployment manifest
aifabrix push {{appName}} --registry {{registry}} # Push to ACR
aifabrix deploy {{appName}}                       # Deploy (controller/env from config)

# Management
aifabrix app register {{appName}}
aifabrix app list
aifabrix app rotate-secret {{appName}}

# Utilities
aifabrix doctor                                   # Check environment
aifabrix login --method device --environment dev  # Login
aifabrix --help                                   # Get help
```

### Build Options

```bash
aifabrix build {{appName}} --tag v1.0.0           # Custom tag
aifabrix build {{appName}} --force-template       # Force template regeneration
aifabrix build {{appName}} --language typescript  # Override language detection
```

### Run Options

```bash
aifabrix run {{appName}} --port {{port}}     # Override port
aifabrix run {{appName}} --debug                  # Debug output
```

### Push Options

```bash
aifabrix push {{appName}} --registry {{registry}} --tag v1.0.0
aifabrix push {{appName}} --registry {{registry}} --tag "v1.0.0,latest,stable"
```

### Deploy Options

```bash
aifabrix deploy {{appName}} --local    # Uses controller and environment from config
aifabrix deploy {{appName}} --no-poll             # Deploy without polling for status
```

### Login Methods

```bash
# Device code flow
aifabrix login --method device --environment dev

# Credentials (reads from secrets.local.yaml)
aifabrix login --method credentials --app {{appName}} --environment dev

# Explicit credentials
aifabrix login --method credentials --app {{appName}} --client-id $CLIENT_ID --client-secret $CLIENT_SECRET --environment dev
```

### Configuration

Set overrides in `~/.aifabrix/config.yaml`:

```yaml
aifabrix-home: "/custom/path"
aifabrix-secrets: "/path/to/secrets.yaml"
```

Controller URL and environment (for `deploy`, `app register`, etc.) are set via `aifabrix login` or `aifabrix auth config --set-controller <url> --set-environment <env>`.

---

## Troubleshooting

- **"Docker not running"** → Start Docker Desktop
- **"Not logged in"** → Run `aifabrix login` first
- **"Port already in use"** → Use `aifabrix run {{appName}} --port <port>` or set `port` in `application.yaml` (default: {{port}})
- **"Authentication failed"** → Run `aifabrix login` again
- **"Build fails"** → Check Docker is running and `aifabrix-secrets` in `config.yaml` is configured correctly
- **"Can't connect"** → Verify infrastructure is running{{#if hasDatabase}} and PostgreSQL is accessible{{/if}}

**Regenerate files:**
```bash
aifabrix resolve {{appName}} --force
aifabrix json {{appName}}
```

---

## Prerequisites

- `@aifabrix/builder` installed globally
- Docker Desktop running
- Azure CLI installed (for push command)
- Authenticated with controller (for deploy command)
{{#unless hasAnyService}}
- Infrastructure running
{{/unless}}
{{#if hasDatabase}}
- PostgreSQL database (ensure infrastructure is running)
{{/if}}
{{#if hasRedis}}
- Redis (ensure infrastructure is running)
{{/if}}
{{#if hasStorage}}
- File storage configured
{{/if}}
{{#if hasAuthentication}}
- Authentication/RBAC configured
{{/if}}

---

**Application**: {{appName}} | **Port**: {{port}} | **Registry**: {{registry}} | **Image**: {{imageName}}:latest
