# Python Docker Compose Template
# Generated by AI Fabrix Builder SDK
# Service definition for local development

services:
  {{app.key}}:
    image: {{image.name}}:{{image.tag}}
    container_name: {{containerName}}
    env_file:
      - {{envFile}}
    ports:
      - "{{hostPort}}:{{containerPort}}"
    networks:
      - {{networkName}}
    {{#if requiresStorage}}
    volumes:
      - {{#if (eq devId 0)}}aifabrix_{{app.key}}_data{{else}}aifabrix_dev{{devId}}_{{app.key}}_data{{/if}}:/mnt/data
    {{/if}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{port}}{{healthCheck.path}}"]
      interval: {{healthCheck.interval}}s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    {{#if requiresDatabase}}
    depends_on:
      db-init:
        condition: service_completed_successfully
    {{/if}}

  {{#if requiresDatabase}}
  # Database Initialization
  db-init:
    image: pgvector/pgvector:pg15
    container_name: {{containerName}}-db-init
    entrypoint: []
    env_file:
      - ${ADMIN_SECRETS_PATH}
      - {{envFile}}
    environment:
      POSTGRES_DB: postgres
      PGHOST: postgres
      PGPORT: "5432"
      PGUSER: pgadmin
      {{#if databases}}
      {{#each databases}}
      DB_{{@index}}_PASSWORD: {{lookup ../databasePasswords.array @index}}
      {{/each}}
      {{else}}
      DB_PASSWORD: {{lookup databasePasswords.array 0}}
      {{/if}}
    networks:
      - {{networkName}}
    volumes: []
    tmpfs:
      - /var/lib/postgresql/data
    command:
      - sh
      - -c
      - |
        export PGHOST=postgres PGPORT=5432 PGUSER=pgadmin &&
        export PGPASSWORD="${POSTGRES_PASSWORD}" &&
        echo 'Waiting for PostgreSQL to be ready...' &&
        counter=0 &&
        while [ ${counter:-0} -lt 30 ]; do
          if pg_isready -h postgres -p 5432 -U pgadmin >/dev/null 2>&1; then
            echo 'PostgreSQL is ready!'
            break
          fi
          echo 'Waiting for PostgreSQL...'
          sleep 1
          counter=$((${counter:-0} + 1))
        done &&
        {{#if databases}}
        {{#each databases}}
        echo 'Creating {{name}} database and user...' &&
        if psql -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname = '{{name}}'" 2>/dev/null | grep -q '^1$'; then
          echo 'Database "{{name}}" already exists, all ok.'
        else
          echo 'Creating database "{{name}}"...' &&
          psql -d postgres -c "CREATE DATABASE \"{{name}}\";" &&
          echo 'Dropping old user if exists...' &&
          psql -d postgres -c "DROP USER IF EXISTS \"{{pgUserOld name}}\";" || true &&
          echo 'Creating user "{{pgUserName name}}"...' &&
          psql -d postgres -c "CREATE USER \"{{pgUserName name}}\" WITH PASSWORD '${DB_{{@index}}_PASSWORD}';" &&
          echo 'Granting privileges...' &&
          psql -d postgres -c "GRANT ALL PRIVILEGES ON DATABASE \"{{name}}\" TO \"{{pgUserName name}}\";" &&
          psql -d {{name}} -c "ALTER SCHEMA public OWNER TO \"{{pgUserName name}}\";" &&
          psql -d {{name}} -c "GRANT ALL ON SCHEMA public TO \"{{pgUserName name}}\";" &&
          echo 'Database "{{name}}" created successfully!'
        fi &&
        {{/each}}
        {{else}}
        echo 'Creating {{app.key}} database and user...' &&
        if psql -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname = '{{app.key}}'" 2>/dev/null | grep -q '^1$'; then
          echo 'Database "{{app.key}}" already exists, all ok.'
        else
          echo 'Creating database "{{app.key}}"...' &&
          psql -d postgres -c "CREATE DATABASE \"{{app.key}}\";" &&
          echo 'Dropping old user if exists...' &&
          psql -d postgres -c "DROP USER IF EXISTS \"{{pgUserOld app.key}}\";" || true &&
          echo 'Creating user "{{pgUserName app.key}}"...' &&
          psql -d postgres -c "CREATE USER \"{{pgUserName app.key}}\" WITH PASSWORD '${DB_0_PASSWORD:-${DB_PASSWORD}}';" &&
          echo 'Granting privileges...' &&
          psql -d postgres -c "GRANT ALL PRIVILEGES ON DATABASE \"{{app.key}}\" TO \"{{pgUserName app.key}}\";" &&
          psql -d {{app.key}} -c "ALTER SCHEMA public OWNER TO \"{{pgUserName app.key}}\";" &&
          psql -d {{app.key}} -c "GRANT ALL ON SCHEMA public TO \"{{pgUserName app.key}}\";" &&
          echo 'Database "{{app.key}}" created successfully!'
        fi &&
        {{/if}}
        echo 'Database initialization complete!'
    restart: "no"
  {{/if}}

{{#if requiresStorage}}
volumes:
  {{#if (eq devId 0)}}
  aifabrix_{{app.key}}_data:
    name: aifabrix_{{app.key}}_data
    driver: local
  {{else}}
  aifabrix_dev{{devId}}_{{app.key}}_data:
    name: aifabrix_dev{{devId}}_{{app.key}}_data
    driver: local
  {{/if}}
{{/if}}

networks:
  {{networkName}}:
    external: true
