# Python Docker Compose Template
# Generated by AI Fabrix Builder SDK
# Service definition for local development

services:
  {{app.key}}:
    image: {{image.name}}:{{image.tag}}
    container_name: aifabrix-{{app.key}}
    env_file:
      - {{envFile}}
    ports:
      - "{{build.localPort}}:{{port}}"
    networks:
      - infra_aifabrix-network
    {{#if requiresStorage}}
    volumes:
      - "{{mountVolume}}:/mnt/data"
    {{/if}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{port}}{{healthCheck.path}}"]
      interval: {{healthCheck.interval}}s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    {{#if requiresDatabase}}
    depends_on:
      db-init:
        condition: service_completed_successfully
    {{/if}}

  {{#if requiresDatabase}}
  # Database Initialization
  db-init:
    image: pgvector/pgvector:pg15
    container_name: aifabrix-{{app.key}}-db-init
    env_file:
      - ${ADMIN_SECRETS_PATH}
    environment:
      POSTGRES_DB: postgres
      PGHOST: postgres
      PGPORT: "5432"
      PGUSER: pgadmin
    networks:
      - infra_aifabrix-network
    command: >
      sh -c "
        export PGHOST=postgres PGPORT=5432 PGUSER=pgadmin &&
        export PGPASSWORD=\"${POSTGRES_PASSWORD}\" &&
        echo 'Waiting for PostgreSQL to be ready...' &&
        counter=0 &&
        while [ $counter -lt 30 ]; do
          if pg_isready -h postgres -p 5432 -U pgadmin >/dev/null 2>&1; then
            echo 'PostgreSQL is ready!'
            break
          fi
          echo 'Waiting for PostgreSQL...'
          sleep 1
          counter=$((counter + 1))
        done &&
        {{#if databases}}
        {{#each databases}}
        echo 'Creating {{name}} database and user...' &&
        (psql -d postgres -c 'CREATE DATABASE {{name}};' || true) &&
        (psql -d postgres -c \"CREATE USER {{name}}_user WITH PASSWORD '{{name}}_pass123';\" || true) &&
        psql -d postgres -c 'GRANT ALL PRIVILEGES ON DATABASE {{name}} TO {{name}}_user;' || true &&
        psql -d {{name}} -c 'ALTER SCHEMA public OWNER TO {{name}}_user;' || true &&
        psql -d {{name}} -c 'GRANT ALL ON SCHEMA public TO {{name}}_user;' || true &&
        {{/each}}
        {{else}}
        echo 'Creating {{app.key}} database and user...' &&
        (psql -d postgres -c 'CREATE DATABASE {{app.key}};' || true) &&
        (psql -d postgres -c \"CREATE USER {{app.key}}_user WITH PASSWORD '{{app.key}}_pass123';\" || true) &&
        psql -d postgres -c 'GRANT ALL PRIVILEGES ON DATABASE {{app.key}} TO {{app.key}}_user;' || true &&
        psql -d {{app.key}} -c 'ALTER SCHEMA public OWNER TO {{app.key}}_user;' || true &&
        psql -d {{app.key}} -c 'GRANT ALL ON SCHEMA public TO {{app.key}}_user;' || true &&
        {{/if}}
        echo 'Database initialization complete!'
      "
    restart: "no"
  {{/if}}

networks:
  infra_aifabrix-network:
    external: true
