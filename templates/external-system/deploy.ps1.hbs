# Deploy {{systemKey}} external system and datasources using aifabrix CLI

$ErrorActionPreference = "Stop"

$SCRIPT_DIR = $PSScriptRoot
$env:ENVIRONMENT = if ($env:ENVIRONMENT) { $env:ENVIRONMENT } else { "dev" }
$env:CONTROLLER = if ($env:CONTROLLER) { $env:CONTROLLER } else { "http://localhost:3000" }

Write-Host "üîç Validating {{systemKey}} configuration files..."
{{#each allJsonFiles}}
aifabrix validate "${SCRIPT_DIR}\{{this}}"
if ($LASTEXITCODE -ne 0) { exit 1 }
{{/each}}

Write-Host "‚úÖ Validation passed"

Write-Host "üöÄ Deploying {{systemKey}} external system and datasources..."
Write-Host "   Environment: $env:ENVIRONMENT"
Write-Host "   Controller: $env:CONTROLLER"

# Deploy datasources
{{#each datasourceFileNames}}
aifabrix datasource deploy {{../systemKey}} "${SCRIPT_DIR}\{{this}}" --environment $env:ENVIRONMENT --controller $env:CONTROLLER
if ($LASTEXITCODE -ne 0) { exit 1 }
{{/each}}

Write-Host "‚úÖ Deployment complete"

# Optional: Run tests
if ($env:RUN_TESTS -eq "true") {
  Write-Host "üß™ Running integration tests..."
  aifabrix test-integration {{systemKey}} --environment $env:ENVIRONMENT --controller $env:CONTROLLER
}

