name: CI/CD Pipeline
on:
  push:
    branches: [{{mainBranch}}]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Run tests
        run: npm test

  deploy:
    name: Deploy to AI Fabrix
    runs-on: ubuntu-latest
    needs: test
    # Note: This workflow deploys to ACR (Azure Container Registry) and Azure
    # For local deployment, use 'aifabrix deploy {{appName}}' directly from your machine
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install AI Fabrix Builder
        run: npm install -g @aifabrix/builder
      
      - name: Authenticate with Controller
        run: |
          set -e
          aifabrix login \
            --method credentials \
            --app {{appName}} \
            --client-id ${{ secrets.DEV_MISO_CLIENTID }} \
            --client-secret ${{ secrets.DEV_MISO_CLIENTSECRET }} \
            --controller ${{ secrets.MISO_CONTROLLER_URL }} \
            --environment dev
      
      - name: Validate Application Manifest
        run: |
          set -e
          aifabrix validate {{appName}}
      
      - name: Build Docker Image
        run: |
          set -e
          aifabrix build {{appName}} --tag ${{ github.sha }}
      
      - name: Deploy Application
        run: |
          set -e
          aifabrix deploy {{appName}}