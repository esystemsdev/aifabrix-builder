{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/esystemsdev/aifabrix-builder/refs/heads/main/lib/schema/external-system.schema.json",
  "title": "AI Fabrix External System Configuration Schema",
  "description": "Schema for configuring an external system connected to the AI Fabrix Dataplane. This defines authentication, OpenAPI/MCP bindings, field mappings defaults, metadata handling and portal inputs.",
  "metadata": {
    "key": "external-system-schema",
    "name": "External System Configuration Schema",
    "description": "JSON schema for validating ExternalSystem configuration files",
    "version": "1.1.0",
    "type": "schema",
    "category": "integration",
    "author": "AI Fabrix Team",
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2025-12-01T00:00:00Z",
    "compatibility": {
      "minVersion": "1.0.0",
      "maxVersion": "2.0.0",
      "deprecated": false
    },
    "tags": [
      "schema",
      "external-system",
      "dataplane",
      "integration",
      "validation"
    ],
    "dependencies": [],
    "changelog": [
      {
        "version": "1.1.0",
        "date": "2025-12-01T00:00:00Z",
        "changes": [
          "Added RBAC roles and permissions support",
          "RBAC roles/permissions are registered with miso-controller during deployment",
          "Roles support Azure AD group mapping via Groups property",
          "Permissions reference roles and are used for access control"
        ],
        "breaking": false
      },
      {
        "version": "1.0.0",
        "date": "2024-01-01T00:00:00Z",
        "changes": [
          "Initial schema for External Systems",
          "Added OpenAPI and MCP contract configuration",
          "Added authentication and environment variables",
          "Added portalInput for UI-driven onboarding",
          "Compatible with field-mappings.schema and security-model.schema"
        ],
        "breaking": false
      }
    ]
  },
  "type": "object",
  "required": [
    "key",
    "displayName",
    "description",
    "type",
    "authentication"
  ],
  "properties": {
    "key": {
      "type": "string",
      "description": "Unique external system identifier (cannot be changed after creation). Example: 'hubspot', 'salesforce', 'teams'.",
      "pattern": "^[a-z0-9-]+$",
      "minLength": 3,
      "maxLength": 40
    },
    "displayName": {
      "type": "string",
      "description": "Human-readable name for the external system",
      "minLength": 1,
      "maxLength": 100
    },
    "description": {
      "type": "string",
      "description": "Description of this external system integration",
      "minLength": 1,
      "maxLength": 500
    },
    "type": {
      "type": "string",
      "enum": [
        "openapi",
        "mcp",
        "custom"
      ],
      "description": "Integration type: OpenAPI-driven, MCP-driven, or custom Python connector."
    },
    "enabled": {
      "type": "boolean",
      "default": true
    },
    "environment": {
      "type": "object",
      "description": "Environment-level configuration values used by dataplane and external data sources.",
      "properties": {
        "baseUrl": {
          "type": "string",
          "description": "Base API URL or MCP server URL",
          "pattern": "^(http|https)://.*$"
        },
        "region": {
          "type": "string",
          "description": "Optional region setting for API routing"
        }
      },
      "additionalProperties": true
    },
    "authentication": {
      "type": "object",
      "description": "Authentication configuration for external system",
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "oauth2",
            "apikey",
            "basic",
            "aad",
            "none"
          ],
          "description": "Authentication type"
        },
        "oauth2": {
          "type": "object",
          "description": "OAuth2 authentication configuration",
          "additionalProperties": true
        },
        "apikey": {
          "type": "object",
          "description": "API key authentication configuration",
          "additionalProperties": true
        },
        "basic": {
          "type": "object",
          "description": "Basic authentication configuration",
          "additionalProperties": true
        },
        "aad": {
          "type": "object",
          "description": "Azure AD authentication configuration",
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "openapi": {
      "type": "object",
      "description": "OpenAPI integration configuration",
      "properties": {
        "documentKey": {
          "type": "string",
          "description": "Key of the OpenAPI document in the registry"
        },
        "specUrl": {
          "type": "string",
          "description": "URL to the OpenAPI specification",
          "pattern": "^(http|https)://.*$"
        }
      },
      "additionalProperties": true
    },
    "mcp": {
      "type": "object",
      "description": "Model Context Protocol integration configuration",
      "properties": {
        "serverUrl": {
          "type": "string",
          "description": "MCP server URL",
          "pattern": "^(http|https)://.*$"
        },
        "toolPrefix": {
          "type": "string",
          "description": "Prefix for MCP tool names",
          "pattern": "^[a-zA-Z0-9_-]+$"
        }
      },
      "additionalProperties": true
    },
    "dataSources": {
      "type": "array",
      "description": "List of data source keys belonging to this external system. Each must match external-datasource.schema.json.",
      "items": {
        "type": "string",
        "pattern": "^[a-z0-9-]+$"
      },
      "uniqueItems": true
    },
    "configuration": {
      "type": "array",
      "description": "External system configuration variables (same pattern as application-schema).",
      "items": {
        "type": "object",
        "required": [
          "name",
          "value",
          "location",
          "required"
        ],
        "properties": {
          "name": {
            "type": "string",
            "pattern": "^[A-Z_][A-Z0-9_]*$"
          },
          "value": {
            "type": "string",
            "description": "Literal value or parameter reference ({{parameter}})"
          },
          "location": {
            "type": "string",
            "enum": [
              "variable",
              "keyvault"
            ]
          },
          "required": {
            "type": "boolean"
          },
          "portalInput": {
            "type": "object",
            "required": [
              "field",
              "label"
            ],
            "properties": {
              "field": {
                "type": "string",
                "enum": [
                  "password",
                  "text",
                  "textarea",
                  "select",
                  "json"
                ]
              },
              "label": {
                "type": "string"
              },
              "placeholder": {
                "type": "string"
              },
              "options": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              },
              "masked": {
                "type": "boolean"
              },
              "validation": {
                "type": "object",
                "properties": {
                  "minLength": {
                    "type": "integer"
                  },
                  "maxLength": {
                    "type": "integer"
                  },
                  "pattern": {
                    "type": "string"
                  },
                  "required": {
                    "type": "boolean"
                  }
                },
                "additionalProperties": false
              }
            },
            "additionalProperties": false
          }
        },
        "additionalProperties": false
      }
    },
    "tags": {
      "type": "array",
      "description": "Optional tags for search / filtering",
      "items": {
        "type": "string"
      }
    },
    "roles": {
      "type": "array",
      "description": "External system roles for Azure AD group mapping",
      "items": {
        "type": "object",
        "required": [
          "name",
          "value",
          "description"
        ],
        "properties": {
          "name": {
            "type": "string",
            "description": "Human-readable role name",
            "minLength": 1,
            "maxLength": 100
          },
          "value": {
            "type": "string",
            "description": "Role identifier (used in JWT and ACL)",
            "pattern": "^[a-z-]+$"
          },
          "description": {
            "type": "string",
            "description": "Role description",
            "minLength": 1,
            "maxLength": 500
          },
          "Groups": {
            "type": "array",
            "description": "Azure AD groups mapped to this role",
            "items": {
              "type": "string",
              "minLength": 1,
              "maxLength": 100
            }
          }
        },
        "additionalProperties": false
      }
    },
    "permissions": {
      "type": "array",
      "description": "External system permissions with role mappings for access control",
      "items": {
        "type": "object",
        "required": [
          "name",
          "roles",
          "description"
        ],
        "properties": {
          "name": {
            "type": "string",
            "description": "Permission identifier (e.g., 'documentstore:read', 'flowise:dev:access')",
            "pattern": "^[a-z0-9-:]+$",
            "minLength": 1,
            "maxLength": 100
          },
          "roles": {
            "type": "array",
            "description": "Roles that have this permission",
            "items": {
              "type": "string",
              "pattern": "^[a-z-]+$",
              "minLength": 1,
              "maxLength": 50
            },
            "minItems": 1
          },
          "description": {
            "type": "string",
            "description": "Permission description",
            "minLength": 1,
            "maxLength": 500
          }
        },
        "additionalProperties": false
      }
    },
    "endpoints": {
      "type": "array",
      "description": "API endpoint configurations for this external system. Used for dynamic endpoint registration at application startup.",
      "items": {
        "type": "object",
        "required": [
          "type",
          "path"
        ],
        "properties": {
          "type": {
            "type": "string",
            "description": "Endpoint type identifier (e.g., 'commands', 'events', 'notifications')",
            "pattern": "^[a-z0-9-]+$"
          },
          "path": {
            "type": "string",
            "description": "URL path for this endpoint (e.g., '/commands', '/events')",
            "pattern": "^/[a-z0-9/-]*$"
          },
          "description": {
            "type": "string",
            "description": "Human-readable description of the endpoint"
          },
          "active": {
            "type": "boolean",
            "description": "Whether this endpoint should be registered (defaults to true)",
            "default": true
          },
          "router": {
            "type": "string",
            "description": "Custom router module path override (defaults to auto-discovery based on naming convention)"
          }
        },
        "additionalProperties": false
      }
    },
    "endpointsActive": {
      "type": "boolean",
      "description": "Master switch for all endpoints in this system. If false, no endpoints are registered regardless of individual endpoint active flags.",
      "default": true
    }
  },
  "additionalProperties": false
}
