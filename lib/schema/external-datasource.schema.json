{
   "$schema":"https://json-schema.org/draft/2020-12/schema",
   "$id":"https://github.com/esystemsdev/aifabrix-builder/blob/main/lib/schema/external-datasource.schema.json",
   "title":"External Data Source",
   "description":"Configuration for AI Fabrix ExternalDataSource entities. Includes metadata schema, ABAC access fields, transformation mappings, OpenAPI/MCP exposure, and sync behavior.",
   "metadata":{
      "key":"external-datasource-schema",
      "name":"External Data Source Configuration Schema",
      "description":"JSON schema for validating ExternalDataSource configuration files",
      "version":"1.0.0",
      "type":"schema",
      "category":"integration",
      "author":"AI Fabrix Team",
      "createdAt":"2024-01-01T00:00:00Z",
      "updatedAt":"2024-01-01T00:00:00Z",
      "compatibility":{
         "minVersion":"1.0.0",
         "maxVersion":"2.0.0",
         "deprecated":false
      },
      "tags":[
         "schema",
         "external-datasource",
         "dataplane",
         "integration",
         "validation"
      ],
      "dependencies":[
         "external-system.schema.json"
      ],
      "changelog":[
         {
            "version":"1.0.0",
            "date":"2024-01-01T00:00:00Z",
            "changes":[
               "Initial schema for External Data Sources",
               "Added fieldMappings DSL with transformation expressions",
               "Added metadataSchema validation",
               "Added exposed fields configuration for MCP/OpenAPI",
               "Added ABAC accessFields validation",
               "Added OpenAPI and MCP operation configurations",
               "Added sync configuration and validation rules"
            ],
            "breaking":false
         }
      ]
   },
   "type":"object",
   "required":[
      "key",
      "displayName",
      "systemKey",
      "entityKey",
      "fieldMappings"
   ],
   "properties":{
      "key":{
         "type":"string",
         "pattern":"^[a-z0-9-]+$",
         "minLength":3,
         "description":"Unique key of data source (e.g. 'hubspot-deal')."
      },
      "displayName":{
         "type":"string",
         "minLength":1
      },
      "description":{
         "type":"string"
      },
      "enabled":{
         "type":"boolean",
         "default":true
      },
      "systemKey":{
         "type":"string",
         "pattern":"^[a-z0-9-]+$",
         "description":"Must match ExternalSystem.key"
      },
      "entityKey":{
         "type":"string",
         "pattern":"^[a-z0-9-]+$"
      },
      "resourceType":{
         "type":"string",
         "enum":["customer","contact","person","document","deal"],
         "default":"document",
         "description":"Resource type for the datasource. Maps to database ResourceType enum."
      },
      "version":{
         "type":"string",
         "pattern":"^[0-9]+\\.[0-9]+\\.[0-9]+$",
         "default":"1.0.0"
      },
      "metadataSchema":{
         "type":"object",
         "description":"Subset of JSON Schema used to validate raw input metadata.",
         "additionalProperties":true
      },
      "fieldMappings":{
         "type":"object",
         "description":"Transformation rules and ABAC accessFields. Replaces older flat mapping schema.",
         "required":[
            "accessFields",
            "fields"
         ],
         "properties":{
            "accessFields":{
               "type":"array",
               "description":"Normalized fields used in ABAC engine (must exist in 'fields').",
               "items":{
                  "type":"string",
                  "pattern":"^[a-zA-Z0-9_]+$"
               },
               "minItems":1,
               "uniqueItems":true
            },
            "fields":{
               "type":"object",
               "description":"Key = normalized field name. Value = transformation expression + type.",
               "additionalProperties":{
                  "type":"object",
                  "required":[
                     "expression",
                     "type"
                  ],
                  "properties":{
                     "expression":{
                        "type":"string",
                        "description":"Pipe-based DSL expression: '{{raw.path}} | toLower | trim'.",
                        "pattern":"^\\s*\\{\\{[^}]+\\}\\}(\\s*\\|\\s*[a-zA-Z0-9_]+(\\([^)]*\\))?)*\\s*$"
                     },
                     "type":{
                        "type":"string",
                        "enum":[
                           "string",
                           "number",
                           "integer",
                           "boolean",
                           "array",
                           "object"
                        ]
                     },
                     "description":{
                        "type":"string"
                     },
                     "required":{
                        "type":"boolean"
                     }
                  }
               }
            }
         }
      },
      "exposed":{
         "type":"object",
         "description":"Defines which normalized fields are exposed through MCP/OpenAPI. Ensures ISO27001-safe output and predictable AI model behavior.",
         "properties":{
            "fields":{
               "type":"array",
               "description":"List of normalized fields (from fieldMappings.fields keys) that the MCP/OpenAPI layers will return.",
               "items":{
                  "type":"string",
                  "pattern":"^[a-zA-Z0-9_]+$"
               },
               "minItems":1,
               "uniqueItems":true
            },
            "omit":{
               "type":"array",
               "description":"Fields that exist in normalized metadata but must NEVER be exposed by MCP/OpenAPI (e.g., secrets, internal IDs). Overrides 'fields'.",
               "items":{
                  "type":"string",
                  "pattern":"^[a-zA-Z0-9_]+$"
               },
               "uniqueItems":true
            },
            "groups":{
               "type":"object",
               "description":"Optional logical grouping for OpenAPI/MCP schema generation (e.g., 'default', 'analytics', 'light').",
               "additionalProperties":{
                  "type":"array",
                  "items":{
                     "type":"string",
                     "pattern":"^[a-zA-Z0-9_]+$"
                  },
                  "minItems":1,
                  "uniqueItems":true
               }
            },
            "readonly":{
               "type":"array",
               "description":"Fields exposed via MCP/OpenAPI but cannot be modified via write operations.",
               "items":{
                  "type":"string",
                  "pattern":"^[a-zA-Z0-9_]+$"
               },
               "uniqueItems":true
            },
            "description":{
               "type":"string",
               "description":"Human-readable description of the exposure model for this data source."
            }
         },
         "required":[
            "fields"
         ],
         "additionalProperties":false
      },
      "sync":{
         "type":"object",
         "description":"Record synchronization rules.",
         "properties":{
            "mode":{
               "type":"string",
               "enum":[
                  "pull",
                  "push",
                  "bidirectional"
               ],
               "default":"pull"
            },
            "schedule":{
               "type":"string"
            },
            "batchSize":{
               "type":"integer",
               "minimum":1,
               "maximum":10000,
               "default":500
            },
            "maxParallelRequests":{
               "type":"integer",
               "minimum":1,
               "maximum":50,
               "default":5
            }
         }
      },
      "openapi":{
         "type":"object",
         "description":"OpenAPI-driven connector configuration.",
         "properties":{
            "enabled":{
               "type":"boolean",
               "default":false
            },
            "documentKey":{
               "type":"string"
            },
            "baseUrl":{
               "type":"string",
               "pattern":"^(http|https)://"
            },
            "resourcePath":{
               "type":"string"
            },
            "operations":{
               "type":"object",
               "properties":{
                  "list":{
                     "type":"object",
                     "required":[
                        "operationId"
                     ],
                     "properties":{
                        "operationId":{
                           "type":"string"
                        },
                        "method":{
                           "type":"string",
                           "enum":[
                              "GET",
                              "POST"
                           ]
                        },
                        "path":{
                           "type":"string"
                        }
                     }
                  },
                  "get":{
                     "type":"object",
                     "required":[
                        "operationId"
                     ],
                     "properties":{
                        "operationId":{
                           "type":"string"
                        },
                        "method":{
                           "type":"string",
                           "enum":[
                              "GET"
                           ]
                        },
                        "path":{
                           "type":"string"
                        }
                     }
                  },
                  "create":{
                     "type":"object",
                     "properties":{
                        "operationId":{
                           "type":"string"
                        },
                        "method":{
                           "type":"string",
                           "enum":[
                              "POST",
                              "PUT"
                           ]
                        },
                        "path":{
                           "type":"string"
                        }
                     }
                  },
                  "update":{
                     "type":"object",
                     "properties":{
                        "operationId":{
                           "type":"string"
                        },
                        "method":{
                           "type":"string",
                           "enum":[
                              "PATCH",
                              "PUT",
                              "POST"
                           ]
                        },
                        "path":{
                           "type":"string"
                        }
                     }
                  },
                  "delete":{
                     "type":"object",
                     "properties":{
                        "operationId":{
                           "type":"string"
                        },
                        "method":{
                           "type":"string",
                           "enum":[
                              "DELETE"
                           ]
                        },
                        "path":{
                           "type":"string"
                        }
                     }
                  }
               }
            },
            "autoRbac":{
               "type":"boolean",
               "default":false,
               "description":"Generates <system>.<entity>.<action> RBAC permissions."
            }
         }
      },
      "mcp":{
         "type":"object",
         "description":"Model Context Protocol exposure.",
         "properties":{
            "enabled":{
               "type":"boolean",
               "default":false
            },
            "toolName":{
               "type":"string",
               "pattern":"^[a-z0-9-]+$"
            },
            "resourceName":{
               "type":"string",
               "pattern":"^[a-z0-9-:]+$"
            },
            "operations":{
               "type":"array",
               "items":{
                  "type":"object",
                  "required":[
                     "name",
                     "permission"
                  ],
                  "properties":{
                     "name":{
                        "type":"string",
                        "pattern":"^[a-z0-9-]+$"
                     },
                     "permission":{
                        "type":"string",
                        "description":"Must match securityModel.permissions",
                        "pattern":"^[a-z0-9-:]+$"
                     },
                     "description":{
                        "type":"string"
                     }
                  }
               }
            }
         }
      },
      "validation":{
         "type":"object",
         "description":"Advanced validation rules applied before saving normalized metadata.",
         "properties":{
            "repeatingValues":{
               "type":"array",
               "items":{
                  "type":"object",
                  "required":[
                     "field",
                     "scope",
                     "strategy"
                  ],
                  "properties":{
                     "field":{
                        "type":"string",
                        "pattern":"^[a-zA-Z0-9_]+$"
                     },
                     "scope":{
                        "type":"array",
                        "items":{
                           "type":"string"
                        }
                     },
                     "strategy":{
                        "type":"string",
                        "enum":[
                           "reject",
                           "latest-wins",
                           "first-wins",
                           "merge"
                        ]
                     },
                     "mergeFields":{
                        "type":"array",
                        "items":{
                           "type":"string"
                        }
                     }
                  }
               }
            }
         }
      },
      "portalInput":{
         "type":"array",
         "description":"Optional UI metadata definition for the AI Fabrix portal.",
         "items":{
            "type":"object",
            "required":[
               "name",
               "field",
               "label"
            ],
            "properties":{
               "name":{
                  "type":"string"
               },
               "field":{
                  "type":"string",
                  "enum":[
                     "text",
                     "textarea",
                     "select",
                     "json",
                     "boolean",
                     "number"
                  ]
               },
               "label":{
                  "type":"string"
               },
               "placeholder":{
                  "type":"string"
               },
               "options":{
                  "type":"array",
                  "items":{
                     "type":"string"
                  }
               },
               "masked":{
                  "type":"boolean"
               },
               "validation":{
                  "type":"object",
                  "properties":{
                     "minLength":{
                        "type":"integer"
                     },
                     "maxLength":{
                        "type":"integer"
                     },
                     "pattern":{
                        "type":"string"
                     },
                     "required":{
                        "type":"boolean"
                     }
                  }
               }
            }
         }
      }
   },
   "additionalProperties":false
}