{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/esystemsdev/aifabrix-builder/blob/main/lib/schema/infrastructure-schema.json",
  "title": "AI Fabrix Infrastructure Configuration Schema",
  "description": "Infrastructure-level configuration schema for AI Fabrix deployment",
  "metadata": {
    "key": "infrastructure-schema",
    "name": "Infrastructure Configuration Schema",
    "description": "JSON schema for validating AI Fabrix infrastructure configuration files",
    "version": "1.0.0",
    "type": "schema",
    "category": "infrastructure",
    "author": "AI Fabrix Team",
    "createdAt": "2024-01-01T00:00:00Z",
    "updatedAt": "2024-01-01T00:00:00Z",
    "compatibility": {
      "minVersion": "1.0.0",
      "maxVersion": "2.0.0",
      "deprecated": false
    },
    "tags": ["schema", "infrastructure", "validation", "configuration"],
    "dependencies": [],
    "changelog": [
      {
        "version": "1.0.0",
        "date": "2024-01-01T00:00:00Z",
        "changes": [
          "Initial infrastructure configuration schema",
          "Added infrastructure resource validation",
          "Added network configuration validation",
          "Added deployment configuration validation"
        ],
        "breaking": false
      }
    ]
  },
  "type": "object",
  "required": [
    "key",
    "environment",
    "preset",
    "serviceName",
    "location",
    "deploymentType",
    "deployment",
    "subscriptionId",
    "tenantId"
  ],
  "properties": {
    "key": {
      "type": "string",
      "description": "Unique infrastructure identifier (cannot be changed after creation)",
      "pattern": "^[a-z0-9-]+$",
      "minLength": 3,
      "maxLength": 40
    },
    "environment": {
      "type": "string",
      "description": "Environment",
      "enum": ["miso", "dev", "tst", "pro"]
    },
    "preset": {
      "type": "string",
      "description": "Resource preset - determines service configurations and sizing",
      "enum": ["evaluation", "s", "m", "l", "xl"],
      "default": "s"
    },
    "serviceName": {
      "type": "string",
      "description": "Service name",
      "pattern": "^[a-z0-9-]{3,40}$"
    },
    "location": {
      "type": "string",
      "description": "Azure region"
    },
    "subscriptionId": {
      "type": "string",
      "description": "Azure subscription ID",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
    },
    "tenantId": {
      "type": "string",
      "description": "Azure tenant ID",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
    },
    "networkAddressSpace": {
      "type": "string",
      "description": "Network address space",
      "pattern": "^(\\d{1,3}\\.){3}\\d{1,3}(\\/\\d{1,2})?$"
    },
    "customDomain": {
      "type": "object",
      "description": "Custom domain configuration",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "name": {
          "type": "string",
          "description": "Domain name"
        }
      },
      "required": ["enabled"]
    },
    "frontDoor": {
      "type": "object",
      "description": "Front Door configuration",
      "properties": {
        "tier": {
          "type": "string",
          "enum": ["Standard", "Premium"]
        }
      },
      "additionalProperties": false
    },
    "networking": {
      "type": "object",
      "description": "Networking configuration",
      "properties": {
        "enablePrivateNetworking": {
          "type": "boolean"
        },
        "enableAzureDns": {
          "type": "boolean"
        }
      }
    },
    "deployment": {
      "type": "object",
      "description": "Deployment configuration",
      "required": ["mode"],
      "properties": {
        "skipValidation": {
          "type": "boolean"
        },
        "dryRun": {
          "type": "boolean"
        },
        "mode": {
          "type": "string",
          "enum": ["marketplace", "infrastructure"]
        }
      }
    },
    "smtp": {
      "type": "object",
      "description": "SMTP configuration",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "host": {
          "type": "string"
        },
        "port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535
        },
        "user": {
          "type": "string"
        },
        "senderEmail": {
          "type": "string",
          "format": "email"
        },
        "useKeyVault": {
          "type": "boolean"
        }
      }
    },
    "containerRegistry": {
      "type": "object",
      "description": "Container Registry configuration",
      "properties": {
        "enabled": {
          "type": "boolean"
        }
      },
      "additionalProperties": false
    },
    "ai": {
      "type": "object",
      "description": "AI services configuration",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "sku": {
          "type": "string",
          "enum": ["S0", "S1", "S2", "S3"]
        },
        "kind": {
          "type": "string",
          "enum": ["OpenAI", "CognitiveServices"]
        }
      },
      "additionalProperties": false
    },
    "storage": {
      "type": "object",
      "description": "Storage configuration",
      "properties": {
        "postgres": {
          "type": "string",
          "description": "PostgreSQL storage size (e.g., 128GB, 1TB)",
          "pattern": "^\\d+(GB|TB)$"
        },
        "blob": {
          "type": "string",
          "description": "Blob storage size (e.g., 128GB, 1TB)",
          "pattern": "^\\d+(GB|TB)$"
        },
        "fileShare": {
          "type": "string",
          "description": "File share storage size (e.g., 64GB, 512GB)",
          "pattern": "^\\d+(GB|TB)$"
        }
      },
      "additionalProperties": false
    },
    "serviceMapping": {
      "type": "object",
      "description": "Service mapping configuration based on preset and environment",
      "properties": {
        "appServicePlan": {
          "type": "object",
          "properties": {
            "sku": { "type": "string" },
            "instances": {
              "type": "object",
              "properties": {
                "min": { "type": "integer" },
                "max": { "type": "integer" }
              }
            }
          }
        },
        "redis": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "sku": { "type": "string" }
          }
        },
        "postgres": {
          "type": "object",
          "properties": {
            "sku": { "type": "string" },
            "storage": { "type": "string" }
          }
        },
        "storage": {
          "type": "object",
          "properties": {
            "size": { "type": "string" }
          }
        },
        "frontDoor": {
          "type": "object",
          "properties": {
            "enabled": { "type": "boolean" },
            "tier": { "type": "string" }
          }
        },
        "monitoring": {
          "type": "object",
          "properties": {
            "applicationInsights": { "type": "boolean" },
            "logAnalytics": { "type": "boolean" },
            "alerts": { "type": "boolean" },
            "dashboards": { "type": "boolean" }
          }
        },
        "networking": {
          "type": "object",
          "properties": {
            "enablePrivateNetworking": { "type": "boolean" },
            "enableAzureDns": { "type": "boolean" },
            "privateEndpoints": { "type": "boolean" }
          }
        }
      }
    },
    "modules": {
      "type": "object",
      "description": "Infrastructure modules configuration",
      "properties": {
        "core": {
          "type": "object",
          "properties": {
            "resourceGroup": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" }
              }
            },
            "network": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" }
              }
            },
            "keyVault": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" }
              }
            },
            "managedIdentity": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" }
              }
            },
            "appServicePlan": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" }
              }
            }
          }
        },
        "storage": {
          "type": "object",
          "properties": {
            "storageAccount": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" }
              }
            },
            "blobStorage": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" },
                "dependsOn": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            },
            "fileShare": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" },
                "dependsOn": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          }
        },
        "database": {
          "type": "object",
          "properties": {
            "postgresServer": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" }
              }
            },
            "postgresDatabases": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" },
                "dependsOn": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            },
            "postgresAccess": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" },
                "dependsOn": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          }
        },
        "cache": {
          "type": "object",
          "properties": {
            "redis": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" }
              }
            }
          }
        },
        "networking": {
          "type": "object",
          "properties": {
            "frontDoor": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" }
              }
            },
            "customDomain": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" },
                "standalone": { "type": "boolean" },
                "directWebAppBinding": { "type": "boolean" }
              }
            },
            "privateEndpoints": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" }
              }
            },
            "dnsZones": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" },
                "dependsOn": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          }
        },
        "monitoring": {
          "type": "object",
          "properties": {
            "applicationInsights": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" }
              }
            },
            "logAnalytics": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" }
              }
            },
            "alerts": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" },
                "dependsOn": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            },
            "dashboards": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" },
                "dependsOn": {
                  "type": "array",
                  "items": { "type": "string" }
                }
              }
            }
          }
        },
        "containerRegistry": {
          "type": "object",
          "properties": {
            "acr": {
              "type": "object",
              "properties": {
                "enabled": { "type": "boolean" },
                "required": { "type": "boolean" },
                "description": { "type": "string" },
                "default": { "type": "boolean" }
              }
            }
          }
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "customDomain": {
            "properties": {
              "enabled": {
                "const": true
              }
            }
          }
        }
      },
      "then": {
        "required": ["customDomain"],
        "properties": {
          "customDomain": {
            "required": ["name"]
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "frontDoor": {
            "properties": {
              "enablePrivateLink": {
                "const": true
              }
            }
          }
        }
      },
      "then": {
        "properties": {
          "frontDoor": {
            "properties": {
              "tier": {
                "const": "Premium"
              }
            }
          }
        }
      }
    }
  ]
}
