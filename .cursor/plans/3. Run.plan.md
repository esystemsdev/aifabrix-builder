<!-- 1a0e1bd7-5873-486b-ac1e-3d9bbb5c8395 84714e5e-e2a5-42d6-a5cb-2d1f0550002b -->
# Implement aifabrix run <app> Command

## Overview

Implement the `aifabrix run <app>` command to run applications locally in Docker containers with automatic infrastructure connectivity, port mapping, health checking, and comprehensive error handling.

## Implementation Steps

### 1. Enable CLI Command Definition (lib/cli.js)

Uncomment and complete the run command (lines 71-74):

```javascript
program.command('run <app>')
  .description('Run application locally')
  .option('-p, --port <port>', 'Override local port')
  .action(async (appName, options) => {
    try {
      await _app.runApp(appName, options);
    } catch (error) {
      handleCommandError(error, 'run');
      process.exit(1);
    }
  });
```

### 2. Implement Core runApp Function (lib/app.js)

Replace the TODO placeholder (lines 93-100) with full implementation:

**Key functionality:**

- Load and validate app configuration from `builder/{appName}/variables.yaml`
- Check if Docker image exists (`docker images | grep {appName}:latest`)
- Verify infrastructure is running (use existing `_infra.checkInfraHealth()`)
- Check if container already exists and stop/remove if needed
- Load environment variables from `builder/{appName}/.env`
- Generate Docker Compose configuration using Handlebars templates
- Start container with `docker-compose up -d`
- Wait for health check to pass
- Display success message with access URL

**Error handling:**

- Image not found → "Run 'aifabrix build {appName}' first"
- Infrastructure not running → "Run 'aifabrix up' first"
- Port conflict → "Port {port} already in use. Try --port {alternative}"
- Container startup failure → Show docker logs and exit

### 3. Add Helper Functions (lib/app.js)

**checkImageExists(appName)**

- Execute `docker images --format "{{.Repository}}:{{.Tag}}" | grep "^{appName}:latest$"`
- Returns boolean

**checkContainerRunning(appName)**

- Execute `docker ps --filter "name=aifabrix-{appName}" --format "{{.Names}}"`
- Returns boolean

**stopAndRemoveContainer(appName)**

- Execute `docker stop aifabrix-{appName} && docker rm aifabrix-{appName}`
- Handles graceful cleanup

**checkPortAvailable(port)**

- Use Node.js `net` module to test port availability
- Returns boolean

**generateDockerCompose(appName, config, options)**

- Load appropriate Handlebars template based on `config.build.language`
- Apply config variables to template
- Handle port override from options
- Add environment file path
- Return generated compose content

**waitForHealthCheck(appName, timeout)**

- Poll container health status every 2 seconds
- Max timeout 60 seconds
- Execute `docker inspect --format='{{.State.Health.Status}}' aifabrix-{appName}`
- Returns when healthy or throws on timeout

### 4. Integration with Existing Modules

**Use validator.js:**

- `validateApplication(appName)` - validate configuration before run
- `checkEnvironment()` - verify Docker availability

**Use infra.js:**

- `checkInfraHealth()` - confirm Postgres/Redis are running

**Use secrets.js (if needed):**

- Ensure `.env` file exists in `builder/{appName}/`

### 5. Implement Comprehensive Tests (tests/lib/app.test.js)

Replace existing placeholder tests (lines 76-106) with full implementation:

**Unit tests:**

- `runApp` with valid configuration
- `runApp` with port override option
- `runApp` when image doesn't exist (error)
- `runApp` when infrastructure not running (error)
- `runApp` when port is in use (error)
- `runApp` when container already running (stop and restart)
- `runApp` health check timeout (error)
- Helper functions: `checkImageExists`, `checkPortAvailable`, `generateDockerCompose`, `waitForHealthCheck`

**Mock strategy:**

- Mock `child_process.exec` for Docker commands
- Mock `fs` operations for config file reading
- Mock `validator.validateApplication` for config validation
- Mock `infra.checkInfraHealth` for infrastructure checks

### 6. Update CLI Reference Documentation (docs/CLI-REFERENCE.md)

The documentation structure already exists (lines 138-165), verify it includes:

- Command syntax and description
- Available flags (`--port`)
- Example usage
- Expected output
- Common error scenarios and solutions
- Integration with `aifabrix up` and `aifabrix build`

Add additional troubleshooting scenarios if needed.

### 7. Security & Compliance (ISO 27001)

**Input validation:**

- Sanitize app name (alphanumeric, dashes only)
- Validate port range (1-65535)
- Prevent path traversal in config file paths

**Logging:**

- Log all Docker operations for audit trail
- Structured error messages with context
- No sensitive data in logs (sanitize env vars)

**Resource management:**

- Proper cleanup on failure
- Temporary file cleanup
- Container resource limits in compose template

## Files to Modify

1. `lib/cli.js` - Uncomment run command (lines 71-74)
2. `lib/app.js` - Implement runApp and helper functions (lines 93-100 and beyond)
3. `tests/lib/app.test.js` - Complete test suite (lines 76-106)
4. `docs/CLI-REFERENCE.md` - Verify/enhance documentation (lines 138-165)

## Files to Read During Implementation

- `lib/validator.js` - Use validation functions
- `lib/infra.js` - Use infrastructure health checks
- `lib/secrets.js` - Understand .env file handling
- `templates/typescript/docker-compose.hbs` - Understand template structure
- `templates/python/docker-compose.hbs` - Understand template structure

## Testing Strategy

1. Unit tests with mocked dependencies (80%+ coverage)
2. Linting with ESLint (no errors)
3. Manual integration test with real Docker environment
4. Verify with `npm run build` (lint + test)

## Expected Behavior

```bash
$ aifabrix run myapp
✓ Infrastructure is running
✓ Starting myapp...
✓ Container aifabrix-myapp started
✓ App running at http://localhost:3000

$ aifabrix run myapp --port 3001
✓ Infrastructure is running
✓ Starting myapp...
✓ Container aifabrix-myapp started
✓ App running at http://localhost:3001
```

### To-dos

- [ ] Uncomment and verify run command in lib/cli.js
- [ ] Implement helper functions (checkImageExists, checkPortAvailable, generateDockerCompose, waitForHealthCheck)
- [ ] Implement main runApp function in lib/app.js with Docker container orchestration
- [ ] Add comprehensive error handling and user-friendly messages
- [ ] Write unit tests for runApp and helper functions in tests/lib/app.test.js
- [ ] Verify CLI command tests work with run command
- [ ] Review and enhance docs/CLI-REFERENCE.md for run command
- [ ] Manual integration test with npm run build and real Docker environment