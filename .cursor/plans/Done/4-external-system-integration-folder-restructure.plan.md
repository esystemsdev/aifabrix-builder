<!-- 26027d92-d412-497f-9a38-403ff2c7cd64 d9aabbcd-5f05-4280-ab2a-fa7b6d1b0001 -->
# External System Integration Folder Restructure

## Overview

Restructure external system creation to use `integration/<app>/` folder instead of `builder/<app>/`. External systems are applications that can be deployed with one system and multiple datasources. **All applications (regular and external) use consistent naming: `<app-name>-deploy.json`** (e.g., `hubspot-deploy.json`, `keycloak-deploy.json`, `myapp-deploy.json`).

## Current State

- External systems are created in `builder/<app>/` folder
- External system JSON files are in `builder/<app>/schemas/`
- Datasource JSON files are in `builder/<app>/schemas/`
- Regular apps use `aifabrix-deploy.json` (inconsistent naming)
- External systems skip JSON generation (uses pipeline API instead)
- `env.template` and `rbac.yaml` are skipped for external type
- README.md template may need improvements for external systems

## Target State

**Folder Structure:**

```
integration/
  <app>/
    variables.yaml                    # App configuration with externalIntegration block
    <app-name>-deploy.json           # External system JSON (generated by `aifabrix json <app>`)
    <app-name>-deploy-<datasource-key>.json  # Datasource JSON files (all in same folder)
    <app-name>-deploy-<datasource-key>.json  # More datasource files
    env.template                      # Environment variables template (like regular apps)
    rbac.yaml                        # RBAC configuration (like regular apps)
    README.md                         # Documentation (improved template)
```

**Key Changes:**

1. External systems use `integration/<app>/` instead of `builder/<app>/`
2. **All apps use consistent naming: `<app-name>-deploy.json`** (regular apps: `builder/<app>/<app-name>-deploy.json`, external: `integration/<app>/<app-name>-deploy.json`)
3. Datasources are in same folder with naming: `<app-name>-deploy-<datasource-key>.json` (e.g., `hubspot-deploy-deal.json`)
4. All files in one folder for easy viewing and ordering
5. External systems have `env.template` and `rbac.yaml` (like regular applications)
6. `aifabrix json <app>` generates `<app-name>-deploy.json` for all apps (consistent naming)
7. New app-scoped datasource commands: `aifabrix <app> datasource list` and `aifabrix <app> datasource validate <datasource-key>`

## Tasks

### Task 1: Update Path Resolution for External Systems

#### 1.1: Create integration folder path utility

**File**: `lib/utils/paths.js` (or new `lib/utils/integration-paths.js`)

- [ ] Add function `getIntegrationPath(appName)` that returns `integration/<app>/`
- [ ] Update all external system path references to use integration folder

#### 1.2: Update external system generator

**File**: `lib/external-system-generator.js`

- [ ] Change datasource output path from `schemas/` to same folder as variables.yaml (`integration/<app>/`)
- [ ] Update datasource file naming to `<app-name>-deploy-<datasource-key>.json` (e.g., `hubspot-deploy-deal.json`)
- [ ] Update `schemaBasePath` in variables.yaml to `./` (same folder) or remove if not needed
- [ ] Update external system JSON path (if it generates one, or it's generated by `json` command)

#### 1.3: Update schema resolver

**File**: `lib/utils/schema-resolver.js`

- [ ] Update `resolveSchemaBasePath()` to check both `builder/<app>/` and `integration/<app>/`
- [ ] Update `resolveExternalFiles()` to use integration folder for external type apps
- [ ] Support both old `builder/` structure (backward compatibility) and new `integration/` structure

### Task 2: Update Application Creation for External Systems

#### 2.1: Update createApp function

**File**: `lib/app.js`

- [ ] Detect if type is "external" and use `integration/` folder instead of `builder/`
- [ ] Update `appPath` construction to use integration folder for external type
- [ ] Update success message to show `integration/<app>/` location
- [ ] Update validation to check integration folder instead of builder folder

#### 2.2: Update app-config generation

**File**: `lib/app-config.js`

- [ ] Remove skip logic for `env.template` for external type (generate it)
- [ ] Remove skip logic for `rbac.yaml` for external type (generate it if authentication enabled)
- [ ] Update `generateDeployJsonFile()` to generate `<app-name>-deploy.json` for all app types (consistent naming)
- [ ] For external type, generate external system JSON as `<app-name>-deploy.json` instead of skipping

#### 2.3: Update templates.js

**File**: `lib/templates.js`

- [ ] Update `generateVariablesYaml()` to set `schemaBasePath: './'` for external type (same folder) or remove if not needed
- [ ] Ensure externalIntegration block is properly configured

### Task 3: Update JSON Generation Command

#### 3.1: Update generator.js

**File**: `lib/generator.js`

- [ ] Update `generateDeployJson()` to detect external type
- [ ] For external type:
  - Load external system JSON from `integration/<app>/<app-name>-deploy.json` if exists, or generate it
  - Use external system JSON structure instead of regular deployment JSON
  - Save as `<app-name>-deploy.json` in integration folder
- [ ] For regular apps, update to use `<app-name>-deploy.json` instead of `aifabrix-deploy.json` (consistent naming)
- [ ] Update all references from `aifabrix-deploy.json` to `<app-name>-deploy.json` throughout codebase
- [ ] Add backward compatibility: check for `aifabrix-deploy.json` if `<app-name>-deploy.json` doesn't exist

#### 3.2: Update all code references to deployment JSON

**Files**: All files that reference `aifabrix-deploy.json`

- [ ] Search codebase for all `aifabrix-deploy.json` references
- [ ] Update to use `<app-name>-deploy.json` with app name resolution
- [ ] Add helper function `getDeployJsonPath(appName)` that:
  - Returns `integration/<app>/<app-name>-deploy.json` for external type
  - Returns `builder/<app>/<app-name>-deploy.json` for regular apps
  - Falls back to `aifabrix-deploy.json` for backward compatibility
- [ ] Update files:
  - `lib/app-deploy.js` - deployment JSON loading
  - `lib/build.js` - build process JSON references
  - `lib/validator.js` - validation JSON path
  - `lib/app-config.js` - config generation
  - Any other files referencing deployment JSON

#### 3.3: Update CLI json command

**File**: `lib/cli.js`

- [ ] Update json command to handle external type apps in integration folder
- [ ] Update output message to show correct file path (`integration/<app>/<app-name>-deploy.json` for external, `builder/<app>/<app-name>-deploy.json` for regular)
- [ ] Update all documentation and error messages to reflect consistent `<app-name>-deploy.json` naming
- [ ] Update command description to mention consistent naming for all apps

### Task 4: Update External System Deployment

#### 4.1: Update external-system-deploy.js

**File**: `lib/external-system-deploy.js`

- [ ] Update `loadVariablesYaml()` to check `integration/<app>/variables.yaml` for external type
- [ ] Update `validateExternalSystemFiles()` to use integration folder paths
- [ ] Update system file path resolution to use `integration/<app>/<app-name>-deploy.json`
- [ ] Update datasource file path resolution to use `integration/<app>/<app-name>-deploy-<datasource-key>.json` (same folder)

#### 4.2: Update build.js

**File**: `lib/build.js`

- [ ] Update external system detection to check integration folder
- [ ] Update path references for external system deployment

#### 4.3: Update app-deploy.js

**File**: `lib/app-deploy.js`

- [ ] Update external system detection to check integration folder
- [ ] Update path references for external system deployment

### Task 5: Update All Commands for Integration Folder

#### 5.1: Update app-register.js

**File**: `lib/app-register.js`

- [ ] Check both `builder/<app>/variables.yaml` and `integration/<app>/variables.yaml`
- [ ] Support external type from integration folder

#### 5.2: Update app-run.js

**File**: `lib/app-run.js`

- [ ] Check integration folder for external type detection
- [ ] Update warning message paths

#### 5.3: Update app-dockerfile.js

**File**: `lib/app-dockerfile.js`

- [ ] Check integration folder for external type detection

#### 5.4: Update app-push.js

**File**: `lib/app-push.js`

- [ ] Check integration folder for external type detection

#### 5.5: Update validator.js

**File**: `lib/validator.js`

- [ ] Update to check integration folder for external type apps
- [ ] Update external file resolution to use same folder with `<app-name>-deploy-<datasource-key>.json` naming

#### 5.6: Update resolve command

**File**: `lib/resolve.js` (or wherever resolve is implemented)

- [ ] Check integration folder for external type apps
- [ ] Update env.template path resolution

### Task 6: Add App-Scoped Datasource Commands

#### 6.1: Create app datasource command structure

**File**: `lib/commands/app-datasource.js` (new)

- [ ] Create `aifabrix <app> datasource list` command
  - Lists datasources filtered by systemKey matching app name
  - Uses `--environment` option
  - Calls datasource-list module with filter
- [ ] Create `aifabrix <app> datasource validate <datasource-key>` command
  - Validates file at `integration/<app>/<app-name>-deploy-<datasource-key>.json` (same folder)
  - Uses datasource-validate module
  - Shows validation results

#### 6.2: Update CLI structure

**File**: `lib/cli.js`

- [ ] Add app command group: `aifabrix <app>`
- [ ] Add datasource subcommand: `aifabrix <app> datasource`
- [ ] Add list subcommand: `aifabrix <app> datasource list`
- [ ] Add validate subcommand: `aifabrix <app> datasource validate <datasource-key>`
- [ ] Wire up to app-datasource command module

#### 6.3: Update datasource-list.js

**File**: `lib/datasource-list.js`

- [ ] Add optional `systemKey` filter parameter
- [ ] Filter datasources by systemKey when provided
- [ ] Update display to show filtered results

### Task 7: Update README Template

#### 7.1: Create external system README template

**File**: `templates/external-system/README.md.hbs` (new)

- [ ] Create dedicated README template for external systems
- [ ] Include external system-specific documentation:
  - External system structure explanation
  - Datasource management commands
  - Pipeline deployment workflow
  - OpenAPI/MCP configuration
  - Authentication setup
- [ ] Include examples for:
  - `aifabrix <app> datasource list`
  - `aifabrix <app> datasource validate <datasource-key>`
  - `aifabrix json <app>` (generates `<app-name>-deploy.json`)
  - `aifabrix login --offline`

#### 7.2: Update app-readme.js

**File**: `lib/app-readme.js`

- [ ] Detect external type and use external-system README template
- [ ] Use regular README template for non-external apps
- [ ] Pass appropriate context variables to template

### Task 8: Update Documentation

#### 8.1: Update QUICK-START.md

**File**: `docs/QUICK-START.md`

- [ ] Update external system creation section to show `integration/<app>/` folder
- [ ] Update file structure examples:
  - `integration/<app>/variables.yaml`
  - `integration/<app>/<app-name>-deploy.json`
  - `integration/<app>/<app-name>-deploy-<datasource-key>.json` (all files in same folder)
- [ ] Add examples for:
  - `aifabrix login --offline`
  - `aifabrix <app> datasource list`
  - `aifabrix <app> datasource validate <datasource-key>`
- [ ] Update workflow steps to reflect integration folder

#### 8.2: Update CLI-REFERENCE.md

**File**: `docs/CLI-REFERENCE.md`

- [ ] Update `aifabrix create` command to show integration folder for external type
- [ ] Update `aifabrix json` command to show `<app-name>-deploy.json` for all apps (consistent naming)
- [ ] Add `aifabrix login --offline` examples
- [ ] Add `aifabrix datasource list --environment dev` examples
- [ ] Add new app-scoped commands:
  - `aifabrix <app> datasource list` - List datasources for app
  - `aifabrix <app> datasource validate <datasource-key>` - Validate datasource
- [ ] Update all path references from `builder/` to `integration/` for external systems

#### 8.3: Update CONFIGURATION.md

**File**: `docs/CONFIGURATION.md`

- [ ] Update externalIntegration section to show integration folder structure
- [ ] Update file structure examples (all files in same folder)
- [ ] Update schemaBasePath examples to `./` (same folder) or remove if not needed

### Task 9: Update Tests

#### 9.1: Update external-system-generator tests

**File**: `tests/lib/external-system-generator.test.js`

- [ ] Update paths to use `integration/` folder
- [ ] Update datasource path assertions to same folder (no subfolder)
- [ ] Update file naming assertions to `<app-name>-deploy-<datasource-key>.json`

#### 9.2: Update external-system-deploy tests

**File**: `tests/lib/external-system-deploy.test.js`

- [ ] Update paths to use `integration/` folder
- [ ] Update system file path to `<app-name>-deploy.json`
- [ ] Update datasource paths to same folder with `<app-name>-deploy-<datasource-key>.json` naming

#### 9.3: Update app creation tests

**Files**: `tests/lib/app.test.js`, `tests/lib/cli.test.js`

- [ ] Add tests for external type using integration folder
- [ ] Test `<app-name>-deploy.json` generation for both regular and external apps
- [ ] Test datasource files created in same folder with `<app-name>-deploy-<datasource-key>.json` naming
- [ ] Test backward compatibility: existing `aifabrix-deploy.json` files still work (with migration path)

#### 9.4: Create app-datasource command tests

**File**: `tests/lib/commands/app-datasource.test.js` (new)

- [ ] Test `aifabrix <app> datasource list` command
- [ ] Test `aifabrix <app> datasource validate <datasource-key>` command
- [ ] Test path resolution for datasource files

### Task 10: Backward Compatibility

#### 10.1: Support both builder and integration folders

**Files**: All files that check for external systems

- [ ] Check `integration/<app>/` first for external type
- [ ] Fall back to `builder/<app>/` for backward compatibility
- [ ] Log deprecation warning when using builder folder for external systems
- [ ] Migration path: suggest moving to integration folder

#### 10.2: Backward compatibility for JSON file naming

**Files**: All files that reference `aifabrix-deploy.json`

- [ ] Support both `aifabrix-deploy.json` (old) and `<app-name>-deploy.json` (new) for regular apps
- [ ] Check for `<app-name>-deploy.json` first, fall back to `aifabrix-deploy.json` if not found
- [ ] Log deprecation warning when using `aifabrix-deploy.json`
- [ ] Migration path: suggest renaming to `<app-name>-deploy.json` for consistency

## Implementation Notes

### File Naming Convention

- **All apps (regular and external)**: `<app-name>-deploy.json` (consistent naming)
  - **Regular apps**: `builder/<app>/<app-name>-deploy.json` (e.g., `builder/myapp/myapp-deploy.json`)
  - **External systems**: `integration/<app>/<app-name>-deploy.json` (e.g., `integration/hubspot/hubspot-deploy.json`)

### Path Resolution Priority

1. Check `integration/<app>/` for external type apps
2. Fall back to `builder/<app>/` for backward compatibility
3. Regular apps always use `builder/<app>/`

### Datasource File Naming

- Format: `<app-name>-deploy-<datasource-key>.json`
- Location: `integration/<app>/` (same folder as variables.yaml and system JSON)
- Example: `integration/hubspot/hubspot-deploy-deal.json`

### External System JSON Structure

The `<app-name>-deploy.json` file contains the external system definition (same as current external-system.json template structure). This is the "application" that gets deployed first, then datasources are deployed separately.

### Command Examples

```bash
# Create external system
aifabrix create hubspot --type external

# Generate deployment JSON (consistent naming for all apps)
aifabrix json hubspot      # Creates integration/hubspot/hubspot-deploy.json
aifabrix json myapp        # Creates builder/myapp/myapp-deploy.json (not aifabrix-deploy.json)

# List datasources for app
aifabrix hubspot datasource list --environment dev

# Validate specific datasource
aifabrix hubspot datasource validate deal  # Validates integration/hubspot/hubspot-deploy-deal.json

# Login with offline token
aifabrix login --controller https://controller.aifabrix.ai --method device --environment dev --offline
```

## Acceptance Criteria

- `aifabrix create hubspot --type external` creates files in `integration/hubspot/`
- External system JSON is `integration/hubspot/hubspot-deploy.json` (generated by `aifabrix json hubspot`)
- Regular app JSON is `builder/<app>/<app-name>-deploy.json` (e.g., `builder/myapp/myapp-deploy.json`)
- **All apps use consistent `<app-name>-deploy.json` naming** (no more `aifabrix-deploy.json`)
- Datasources are in same folder: `integration/hubspot/hubspot-deploy-<datasource-key>.json` (e.g., `hubspot-deploy-deal.json`)
- All files in one folder for easy viewing and ordering
- `env.template` and `rbac.yaml` are generated for external systems
- `aifabrix hubspot datasource list --environment dev` lists datasources filtered by systemKey
- `aifabrix hubspot datasource validate deal` validates `integration/hubspot/hubspot-deploy-deal.json`
- All existing commands work with integration folder
- Backward compatibility maintained for builder folder and `aifabrix-deploy.json` naming
- Documentation updated with new structure and commands
- All tests pass