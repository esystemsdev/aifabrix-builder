<!-- 12c16968-6be5-4a31-8992-352576ab55a2 a41d1a4c-658d-48bd-93e4-47ef7849d23d -->
# Implement aifabrix push <app> Command

## Overview

Implement the `push` command to push Docker images to Azure Container Registry (ACR) with Azure CLI authentication, support for multiple tags, registry reading from variables.yaml or CLI flags, and comprehensive error handling with security logging.

## Key Features

- Azure CLI authentication (`az acr login`)
- Registry from `--registry` flag or `variables.yaml` (flag takes precedence)
- Multiple comma-separated tags support (`--tag "v1.0.0,latest,stable"`)
- Error if local image doesn't exist (suggest building first)
- Direct registry push (no Pipeline API integration)
- ISO 27001 compliant logging and error handling

## Implementation Steps

### 1. Core Push Function (`lib/app.js`)

Implement `pushApp(appName, options)` function with:

- Load configuration from `builder/<app>/variables.yaml`
- Determine registry: use `options.registry` if provided, otherwise `config.image.registry`
- Validate registry URL format (should be ACR URL like `*.azurecr.io`)
- Parse tags from `options.tag` (comma-separated string, default: `latest`)
- Check if local image exists (`<appName>:latest`)
- Authenticate with ACR using Azure CLI
- Tag image for each tag in the list
- Push each tagged image to ACR
- Verify push completion
- Log all operations for audit trail

**Key validations:**

- App configuration exists
- Registry is specified (either flag or config)
- Local Docker image exists
- Azure CLI is installed and authenticated
- Registry URL is valid ACR format

### 2. Helper Functions (`lib/app.js`)

Create supporting functions:

**`checkAzureCLIInstalled()`**

- Verify `az` command is available
- Return installation status

**`checkACRAuthentication(registry)`**

- Check if already logged into the registry
- Return authentication status

**`authenticateACR(registry)`**

- Run `az acr login --name <registry-name>`
- Handle authentication errors
- Return authentication result

**`checkImageExists(imageName, tag)`**

- Run `docker images` to check if image exists locally
- Return boolean

**`tagImage(sourceImage, targetImage)`**

- Run `docker tag` command
- Handle tagging errors
- Log operation

**`pushImage(imageWithTag)`**

- Run `docker push` command
- Show progress
- Handle push errors
- Return push result

**`extractRegistryName(registryUrl)`**

- Extract registry name from URL (e.g., `myacr.azurecr.io` → `myacr`)
- Validate format

### 3. CLI Command Integration (`lib/cli.js`)

Uncomment and implement the push command:

```javascript
program.command('push <app>')
  .description('Push image to Azure Container Registry')
  .option('-r, --registry <registry>', 'ACR registry URL (overrides variables.yaml)')
  .option('-t, --tag <tag>', 'Image tag(s) - comma-separated for multiple (default: latest)')
  .action(async (app, options) => {
    try {
      await _app.pushApp(app, options);
    } catch (error) {
      handleCommandError(error, 'push');
      process.exit(1);
    }
  });
```

### 4. Error Handling

Add specific error messages in `handleCommandError()`:

- Azure CLI not installed
- Not authenticated with ACR
- Image doesn't exist locally
- Registry URL invalid
- Network/connectivity issues
- Permission denied (ACR access)
- Registry not found

### 5. Tests (`tests/lib/app.test.js`)

Implement comprehensive test suite for `pushApp`:

**Test Cases:**

- Successfully pushes image with default tag
- Successfully pushes image with multiple tags
- Uses registry from command flag (overrides config)
- Uses registry from variables.yaml when no flag
- Errors when image doesn't exist locally
- Errors when Azure CLI not installed
- Errors when not authenticated with ACR
- Errors when registry is invalid format
- Errors when app configuration missing
- Errors when no registry specified (neither flag nor config)
- Handles network errors gracefully
- Logs all operations for audit trail
- Tags image correctly before pushing
- Verifies push completion

**Mock Dependencies:**

- Mock `child_process.exec` for Docker and Azure CLI commands
- Mock file system operations for reading variables.yaml
- Mock console output for user feedback

### 6. Documentation Updates

**Update `docs/CLI-REFERENCE.md`:**

- Expand push command section with detailed examples
- Add troubleshooting section for common issues
- Document authentication flow
- Add examples for multiple tags

**Update `docs/DEPLOYING.md` (if needed):**

- Ensure examples match implementation
- Add notes about Azure CLI requirements

**Create integration examples:**

- Local development workflow
- CI/CD pipeline examples
- Multi-environment deployments

## Files to Modify

1. **`lib/app.js`** - Implement `pushApp()` and helper functions
2. **`lib/cli.js`** - Uncomment and configure push command
3. **`tests/lib/app.test.js`** - Add comprehensive tests for push functionality
4. **`docs/CLI-REFERENCE.md`** - Enhance push command documentation
5. **`docs/DEPLOYING.md`** - Add detailed workflow examples (if needed)

## Security & Compliance (ISO 27001)

- **Audit Logging**: Log all push operations with timestamps, user, image, registry
- **Error Handling**: Never expose sensitive data (tokens, passwords) in error messages
- **Input Validation**: Validate all inputs (app name, registry URL, tags)
- **Secure Communication**: Use HTTPS for registry communication
- **Access Control**: Verify Azure CLI authentication before attempting push
- **Data Protection**: Handle registry credentials securely via Azure CLI

## Acceptance Criteria

- ✅ Command executes: `aifabrix push myapp --registry myacr.azurecr.io --tag v1.0.0`
- ✅ Multiple tags work: `aifabrix push myapp --registry myacr.azurecr.io --tag "v1.0.0,latest,stable"`
- ✅ Registry from config works when no flag provided
- ✅ Error shown if image doesn't exist (with helpful message)
- ✅ Azure CLI authentication checked before push
- ✅ All operations logged for audit
- ✅ Tests have 80%+ coverage
- ✅ Documentation is complete and accurate
- ✅ Linting passes with no errors
- ✅ All tests pass (100% success rate)

### To-dos

- [ ] Implement pushApp() function in lib/app.js with configuration loading, registry resolution, image validation, and push orchestration
- [ ] Create helper functions for Azure CLI checks, ACR authentication, image operations, and registry name extraction
- [ ] Uncomment and configure push command in lib/cli.js with proper options and error handling
- [ ] Write comprehensive test suite in tests/lib/app.test.js covering all push scenarios and error cases
- [ ] Update CLI-REFERENCE.md and DEPLOYING.md with detailed push command examples and troubleshooting
- [ ] Run build, linting, and tests to ensure all quality gates pass before completion