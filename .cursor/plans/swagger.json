{"openapi":"3.0.0","paths":{"/":{"get":{"description":"Service info. No client certificate required. Use /api-docs for API documentation.","operationId":"AppController_getRoot","parameters":[],"responses":{"200":{"description":"Service info"}},"summary":"Root","tags":["health"]}},"/health":{"get":{"description":"Returns service health status. Use for liveness/readiness probes. No client certificate required.","operationId":"AppController_getHealth","parameters":[],"responses":{"200":{"description":"Service is healthy","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HealthResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"summary":"Health check","tags":["health"]}},"/api/dev/users":{"get":{"description":"Returns all registered developer users. Each item includes id, name, email, createdAt, groups (access groups: admin, secret-manager, developer), and certificate status (certificateIssued, certificateValidNotAfter).","operationId":"DevController_listUsers","parameters":[],"responses":{"200":{"description":"List of developer users (each includes groups)","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/UserResponseDto"}}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"List developer users","tags":["dev"]},"post":{"description":"Registers a new developer by ID, name, and email. developerId must be unique and numeric. Optional groups default to [developer].","operationId":"DevController_createUser","parameters":[],"requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/CreateUserDto"}}}},"responses":{"201":{"description":"User created","content":{"application/json":{"schema":{"$ref":"#/components/schemas/UserResponseDto"}}}},"400":{"description":"Validation error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"409":{"description":"User id already exists","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Create a developer user","tags":["dev"]}},"/api/dev/users/{id}":{"patch":{"description":"Partially updates name, email, or groups. At least one field is required.","operationId":"DevController_updateUser","parameters":[{"name":"id","required":true,"in":"path","description":"Developer ID","schema":{"example":"01","type":"string"}}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/UpdateUserDto"}}}},"responses":{"200":{"description":"User updated","content":{"application/json":{"schema":{"$ref":"#/components/schemas/UserResponseDto"}}}},"400":{"description":"Validation error or no fields provided","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"User not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Update a developer user","tags":["dev"]},"delete":{"description":"Removes the developer user with the given ID. Returns 404 if not found.","operationId":"DevController_deleteUser","parameters":[{"name":"id","required":true,"in":"path","description":"Developer ID","schema":{"example":"01","type":"string"}}],"responses":{"200":{"description":"User deleted","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DeletedResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"User not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Delete a developer user","tags":["dev"]}},"/api/dev/users/{id}/pin":{"post":{"description":"Creates a one-time PIN for the developer to use in issue-cert. Any existing PIN for this user is replaced. PIN is single-use and time-limited.","operationId":"DevController_createPin","parameters":[{"name":"id","required":true,"in":"path","description":"Developer ID","schema":{"example":"01","type":"string"}}],"responses":{"201":{"description":"PIN created","content":{"application/json":{"schema":{"$ref":"#/components/schemas/CreatePinResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"User not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Create or regenerate one-time PIN","tags":["dev"]}},"/api/dev/issue-cert":{"post":{"description":"Validates the developer PIN and CSR, then signs the CSR with the builder CA and returns the certificate plus validity (validDays, validNotAfter). The PIN is consumed and cannot be reused. The user's certificate validity is stored for list-users.","operationId":"DevController_issueCert","parameters":[],"requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/IssueCertDto"}}}},"responses":{"201":{"description":"Certificate issued","content":{"application/json":{"schema":{"$ref":"#/components/schemas/IssueCertResponseDto"}}}},"400":{"description":"Validation error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"401":{"description":"Invalid or expired PIN","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"Developer not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"503":{"description":"CA or signing unavailable","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"summary":"Issue certificate","tags":["dev"]}},"/api/dev/users/{id}/ssh-keys":{"post":{"description":"Appends an SSH public key for the developer (e.g. after PIN auth or during onboarding). Multiple keys per user allowed (one per computer). Regenerates the managed authorized_keys file.","operationId":"DevController_addSshKey","parameters":[{"name":"id","required":true,"in":"path","description":"Developer ID","schema":{"example":"01","type":"string"}}],"requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/AddSshKeyDto"}}}},"responses":{"201":{"description":"SSH key added","content":{"application/json":{"schema":{"$ref":"#/components/schemas/SshKeyItemDto"}}}},"400":{"description":"Validation error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"User not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"409":{"description":"Key with this fingerprint already exists","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Add SSH public key for a developer","tags":["dev"]},"get":{"description":"Returns all SSH keys registered for the developer (fingerprint, label, createdAt).","operationId":"DevController_listSshKeys","parameters":[{"name":"id","required":true,"in":"path","description":"Developer ID","schema":{"example":"01","type":"string"}}],"responses":{"200":{"description":"List of SSH keys","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/SshKeyItemDto"}}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"User not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"List SSH public keys for a developer","tags":["dev"]}},"/api/dev/users/{id}/ssh-keys/{fingerprint}":{"delete":{"description":"Removes the key identified by fingerprint. Regenerates the managed authorized_keys file.","operationId":"DevController_removeSshKey","parameters":[{"name":"id","required":true,"in":"path","description":"Developer ID","schema":{"example":"01","type":"string"}},{"name":"fingerprint","required":true,"in":"path","description":"Key fingerprint (from add or list)","schema":{"example":"a1b2c3d4e5f6g7h8","type":"string"}}],"responses":{"200":{"description":"Key removed","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DeletedResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"User or key not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Remove an SSH key for a developer","tags":["dev"]}},"/api/dev/settings":{"get":{"description":"Returns the current developer's Mutagen folder path and client configuration (remote-server, docker-endpoint, secrets paths, encryption key value). The developer is identified by the client certificate CN. Used by the Builder CLI to configure Mutagen sync and local dev environment.","operationId":"DevController_getSettings","parameters":[],"responses":{"200":{"description":"Settings for the authenticated developer","content":{"application/json":{"schema":{"$ref":"#/components/schemas/SettingsResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"Developer not found (cert CN not registered)","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"503":{"description":"Secrets encryption key not available","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Get developer settings (cert-authenticated)","tags":["dev"]}},"/api/dev/secrets":{"get":{"description":"Returns every stored secret with its key name and decrypted value. Values are stored encrypted at rest.","operationId":"SecretsController_listSecrets","parameters":[],"responses":{"200":{"description":"List of secrets (name and value)","content":{"application/json":{"schema":{"type":"array","items":{"$ref":"#/components/schemas/SecretItemDto"}}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"503":{"description":"Secrets encryption key not available","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"List all secrets","tags":["secrets"]},"post":{"description":"Stores a secret by key. The value is encrypted before persistence. If the key already exists, the value is updated.","operationId":"SecretsController_addSecret","parameters":[],"requestBody":{"required":true,"content":{"application/json":{"schema":{"$ref":"#/components/schemas/AddSecretDto"}}}},"responses":{"201":{"description":"Secret added or updated","content":{"application/json":{"schema":{"$ref":"#/components/schemas/AddSecretResponseDto"}}}},"400":{"description":"Validation error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"503":{"description":"Secrets encryption key not available","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Add or update a secret","tags":["secrets"]}},"/api/dev/secrets/{key}":{"delete":{"description":"Deletes the secret with the given key. Returns 404 if the key does not exist.","operationId":"SecretsController_deleteSecret","parameters":[{"name":"key","required":true,"in":"path","description":"Secret key name","schema":{"example":"npm-token","type":"string"}}],"responses":{"200":{"description":"Secret removed","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DeleteSecretResponseDto"}}}},"401":{"description":"Missing or invalid client certificate","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"404":{"description":"Secret not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}},"500":{"description":"Internal server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponseDto"}}}}},"security":[{"clientCert":[]}],"summary":"Remove a secret by key","tags":["secrets"]}}},"info":{"title":"Builder Server API","description":"AI Fabrix builder-server: developers, certificates, secrets. Public routes (no client cert): GET /, GET /health, POST /api/dev/issue-cert. All other routes require a valid TLS client certificate (issued via POST /api/dev/issue-cert). When TLS is terminated at nginx, the cert is passed in the X-Client-Cert header. All errors return a standard structure: statusCode, error, message, and optional code.","version":"1.0","contact":{}},"tags":[{"name":"health","description":""},{"name":"dev","description":""},{"name":"secrets","description":""}],"servers":[],"components":{"securitySchemes":{"clientCert":{"type":"apiKey","in":"header","name":"X-Client-Cert","description":"PEM client certificate (set by nginx when TLS is terminated at reverse proxy)"}},"schemas":{"HealthResponseDto":{"type":"object","properties":{"status":{"type":"string","description":"Service status","example":"ok","enum":["ok"]}},"required":["status"]},"ErrorResponseDto":{"type":"object","properties":{"statusCode":{"type":"number","description":"HTTP status code","example":404},"error":{"type":"string","description":"Short error type or reason phrase","example":"Not Found"},"message":{"type":"string","description":"Human-readable error message","example":"User 99 not found"},"code":{"type":"string","description":"Optional stable machine-readable code for client logic","example":"NOT_FOUND"}},"required":["statusCode","error","message"]},"UserResponseDto":{"type":"object","properties":{"id":{"type":"string","description":"Developer ID (numeric string)","example":"01"},"name":{"type":"string","description":"Display name","example":"Jane Doe"},"email":{"type":"string","description":"Email address","example":"jane@example.com"},"createdAt":{"type":"string","description":"Creation time in ISO 8601 format","example":"2025-02-16T12:00:00.000Z"},"certificateIssued":{"type":"boolean","description":"Whether a developer certificate has been issued for this user.","example":true},"certificateValidNotAfter":{"type":"string","description":"When the issued certificate is valid until (ISO 8601). Present only when certificateIssued is true.","example":"2026-03-18T14:32:00.000Z"},"groups":{"description":"Access groups (admin, secret-manager, developer).","example":["developer"],"type":"array","items":{"type":"string"}}},"required":["id","name","email","createdAt","certificateIssued","groups"]},"CreateUserDto":{"type":"object","properties":{"developerId":{"type":"string","example":"01","description":"Developer ID: numeric string, unique per user. Used in issue-cert and PIN creation."},"name":{"type":"string","example":"Jane Doe","description":"Display name of the developer."},"email":{"type":"string","example":"jane@example.com","description":"Developer email address."},"groups":{"example":["developer"],"description":"Access groups. Allowed: admin, secret-manager, developer. Defaults to [developer] if omitted.","type":"array","items":{"type":"string"}}},"required":["developerId","name","email"]},"UpdateUserDto":{"type":"object","properties":{"name":{"type":"string","example":"Jane Doe","description":"Display name of the developer."},"email":{"type":"string","example":"jane@example.com","description":"Developer email address."},"groups":{"example":["developer","secret-manager"],"description":"Access groups. Allowed values: admin, secret-manager, developer. At least one required if provided.","type":"array","items":{"type":"string"}}}},"DeletedResponseDto":{"type":"object","properties":{"deleted":{"type":"string","description":"ID or key of the deleted resource","example":"01"}},"required":["deleted"]},"CreatePinResponseDto":{"type":"object","properties":{"pin":{"type":"string","description":"One-time PIN for certificate issuance. Single-use, show once; valid until expiresAt (e.g. 24h TTL).","example":"123456"},"expiresAt":{"type":"string","description":"PIN expiry time in ISO 8601 format. After this time the PIN cannot be used for issue-cert.","example":"2025-02-17T12:00:00.000Z"}},"required":["pin","expiresAt"]},"IssueCertDto":{"type":"object","properties":{"developerId":{"type":"string","description":"Developer ID (must match the user for whom the PIN was created).","example":"01"},"pin":{"type":"string","description":"One-time PIN returned from POST /api/dev/users/:id/pin. Consumed on successful use.","example":"123456"},"csr":{"type":"string","description":"PEM-encoded Certificate Signing Request (CSR) to be signed by the builder CA.","example":"-----BEGIN CERTIFICATE REQUEST-----\\n...\\n-----END CERTIFICATE REQUEST-----"}},"required":["developerId","pin","csr"]},"IssueCertResponseDto":{"type":"object","properties":{"certificate":{"type":"string","description":"PEM-encoded X.509 certificate signed by the builder CA. PIN is consumed after success.","example":"-----BEGIN CERTIFICATE-----\\n...\\n-----END CERTIFICATE-----"},"validDays":{"type":"number","description":"Number of days the certificate is valid from issuance.","example":30},"validNotAfter":{"type":"string","description":"Certificate validity end date in ISO 8601 format (UTC).","example":"2026-03-18T14:32:00.000Z"}},"required":["certificate","validDays","validNotAfter"]},"AddSshKeyDto":{"type":"object","properties":{"publicKey":{"type":"string","description":"SSH public key line (e.g. ssh-rsa AAAA... comment).","example":"ssh-rsa AAAAB3NzaC1yc2E... user@host"},"label":{"type":"string","description":"Optional label for this key (e.g. laptop, work).","example":"laptop"}},"required":["publicKey"]},"SshKeyItemDto":{"type":"object","properties":{"fingerprint":{"type":"string","description":"Fingerprint used to identify this key for removal.","example":"a1b2c3d4e5f6g7h8"},"label":{"type":"string","description":"Optional label.","example":"laptop"},"createdAt":{"type":"string","description":"When the key was added (ISO 8601).","example":"2026-02-16T12:00:00.000Z"}},"required":["fingerprint"]},"SettingsResponseDto":{"type":"object","properties":{"user-mutagen-folder":{"type":"string","description":"Full server (host) path to this user's workspace root (workspace/dev-<id>), no app segment. Use for Mutagen sync target and to build Docker -v mount: e.g. -v ${user-mutagen-folder}/dev/<app>:/app when starting container with --remote.","example":"/opt/aifabrix/builder-server/data/workspace/dev-01"},"secrets-encryption":{"type":"string","description":"Encryption key value (hex) for local secrets decryption. Cert-protected; never log.","example":"685d4b7ab1ec43fa..."},"aifabrix-secrets":{"type":"string","description":"Path for the project secrets file.","example":"/aifabrix-miso/builder/secrets.local.yaml"},"aifabrix-env-config":{"type":"string","description":"Path for env config.","example":"aifabrix-miso/builder/env-config.yaml"},"remote-server":{"type":"string","description":"Builder-server base URL.","example":"https://dev.aifabrix.dev"},"docker-endpoint":{"type":"string","description":"Docker API endpoint for the dev server.","example":"tcp://dev.aifabrix.dev:2376"},"sync-ssh-user":{"type":"string","description":"SSH user for Mutagen sync (dedicated OS user on the server, no sudo).","example":"aifabrix-sync"},"sync-ssh-host":{"type":"string","description":"SSH host for Mutagen sync (hostname to connect to). May match remote-server host or be a dedicated SSH host.","example":"dev.aifabrix.dev"}},"required":["user-mutagen-folder","secrets-encryption","aifabrix-secrets","aifabrix-env-config","remote-server","docker-endpoint","sync-ssh-user","sync-ssh-host"]},"SecretItemDto":{"type":"object","properties":{"name":{"type":"string","description":"Secret key name","example":"npm-token"},"value":{"type":"string","description":"Decrypted secret value","example":"secret-value"}},"required":["name","value"]},"AddSecretDto":{"type":"object","properties":{"key":{"type":"string","example":"npm-token","description":"Secret key name. Used to identify the secret when listing or deleting. Max 255 characters."},"value":{"type":"string","description":"Secret value. Stored encrypted at rest; returned decrypted when listing secrets.","example":"secret-value"}},"required":["key","value"]},"AddSecretResponseDto":{"type":"object","properties":{"key":{"type":"string","description":"Secret key that was added or updated","example":"npm-token"}},"required":["key"]},"DeleteSecretResponseDto":{"type":"object","properties":{"deleted":{"type":"string","description":"Secret key that was removed","example":"npm-token"}},"required":["deleted"]}}}}