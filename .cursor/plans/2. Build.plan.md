<!-- 00f92552-8c6a-4d49-aac6-5c8b4c5429da 3f82088a-0d3d-4d73-a04f-4a2143c22839 -->
# Implement aifabrix build Command

## Overview

Implement the complete build command that:

1. Loads application configuration from `builder/{appName}/variables.yaml`
2. Detects runtime language or uses specified language
3. Generates Dockerfile from Handlebars templates if needed
4. Builds Docker image with proper build context
5. Tags image appropriately
6. Generates `.env` file from `env.template`

## Implementation Steps

### 1. Implement Language Detection (`lib/app.js`)

**Function: `detectLanguage(appPath)`**

- Check for `package.json` → TypeScript/Node.js
- Check for `requirements.txt` or `pyproject.toml` → Python
- Check for custom `Dockerfile` → Use existing
- Return detected language or throw error

### 2. Implement Dockerfile Generation (`lib/app.js`)

**Function: `generateDockerfile(appPath, language, config)`**

- Load Handlebars template from `templates/{language}/Dockerfile.hbs`
- Compile template with configuration variables:
  - `port` from config
  - `healthCheck.interval` and `healthCheck.path`
  - `startupCommand` if specified
- Write generated Dockerfile to `.aifabrix/Dockerfile.{language}`
- Return path to generated file

### 3. Implement Build Function (`lib/app.js`)

**Function: `buildApp(appName, options)`**

**Steps:**

1. **Load and Validate Configuration**

   - Use existing `loadVariablesYaml()` helper (to be implemented)
   - Call `validator.validateVariables(appName)` to validate schema
   - If validation fails, show errors and exit
   - Extract: `image.name`, `port`, `build.language`, `build.context`, `build.dockerfile`

2. **Determine Language**

   - Use `options.language` if provided (override)
   - Otherwise use `config.build.language`
   - Otherwise detect from build context using `detectLanguage()`

3. **Determine Dockerfile**

   - If `config.build.dockerfile` exists and file found → use it
   - If `options.forceTemplate === true` → generate from template
   - If no Dockerfile found → generate from template
   - Otherwise → use existing Dockerfile

4. **Generate Dockerfile (if needed)**

   - Call `generateDockerfile()` with language and config
   - Store in `.aifabrix/Dockerfile.{language}`

5. **Build Docker Image**

   - Determine build context path (from `config.build.context` or current dir)
   - Construct docker build command:
     ```bash
     docker build -t {image.name}:latest -f {dockerfilePath} {contextPath}
     ```

   - Execute command and stream output
   - Handle errors with helpful messages

6. **Tag Image**

   - If `options.tag` provided, also tag as `{image.name}:{tag}`

7. **Generate .env File**

   - Call `secrets.generateEnvFile(appName, config.build.secrets)`
   - Resolves kv:// references
   - Writes to `builder/{appName}/.env`
   - Copies to `build.envOutputPath` if specified

8. **Return Success**

   - Return image tag that was built
   - Display success message

### 4. Enable Build Command in CLI (`lib/cli.js`)

**Uncomment and wire up:**

```javascript
program.command('build <app>')
  .description('Build container image (auto-detects runtime)')
  .option('-l, --language <lang>', 'Override language detection')
  .option('-f, --force-template', 'Force rebuild from template')
  .option('-t, --tag <tag>', 'Image tag (default: latest)')
  .action(async (appName, options) => {
    try {
      const imageTag = await _app.buildApp(appName, options);
      console.log(`✅ Built image: ${imageTag}`);
    } catch (error) {
      handleCommandError(error, 'build');
      process.exit(1);
    }
  });
```

### 5. Create Comprehensive Tests (`tests/lib/app.test.js`)

**Test Coverage:**

- Language detection for TypeScript (package.json)
- Language detection for Python (requirements.txt)
- Dockerfile generation from templates
- Build with custom Dockerfile
- Build with generated Dockerfile
- Force template regeneration
- Image tagging
- Error handling (missing config, Docker errors)
- .env file generation during build

### 6. Implement Helper Functions

**`executeDockerBuild(imageName, dockerfilePath, contextPath, tag)`**

- Constructs docker command
- Executes with proper error handling
- Streams output to console
- Returns success/failure

**`resolveContextPath(builderPath, contextPath)`**

- Resolves relative context paths
- Validates path exists
- Returns absolute path

**`loadVariablesYaml(appName)`**

- Reads variables.yaml
- Parses YAML
- Validates schema
- Returns configuration object

## Key Files to Modify

1. **`lib/app.js`** - Main implementation (buildApp, detectLanguage, generateDockerfile)
2. **`lib/cli.js`** - Enable build command (uncomment lines 65-69)
3. **`tests/lib/app.test.js`** - Comprehensive test coverage
4. **Templates already exist:**

   - `templates/typescript/Dockerfile.hbs`
   - `templates/python/Dockerfile.hbs`

## Quality Standards Compliance

### ISO 27001 & Security

- No hardcoded secrets in Dockerfiles
- Use environment variables via .env resolution
- Dockerfiles use non-root users
- Alpine base images for minimal attack surface
- All inputs validated and sanitized

### Code Quality

- Each function ≤50 lines
- File stays ≤500 lines (split if needed)
- Comprehensive error handling
- Structured logging for audit trail
- JSDoc documentation for all functions

### Testing

- 80%+ test coverage
- All functions have unit tests
- Integration test for full build flow
- Mock Docker commands appropriately
- Tests in separate `tests/` directory

### Build Validation

- Run `npm run lint` - must pass
- Run `npm test` - 100% pass rate
- Verify file size limits
- Check test coverage reports

## Expected Behavior

```bash
# Example usage
$ aifabrix build myapp

✓ Loaded configuration from builder/myapp/variables.yaml
✓ Detected language: typescript
✓ Using Dockerfile from: .aifabrix/Dockerfile.typescript
✓ Building image...
[Docker build output...]
✓ Image built: myapp:latest
✓ Generated .env file at builder/myapp/.env
✓ Copied .env to ../packages/myapp/.env

Build completed successfully!
```

## Error Scenarios to Handle

1. **Missing variables.yaml** → "Configuration not found. Run `aifabrix create myapp` first."
2. **Docker not running** → "Docker is not running. Please start Docker Desktop."
3. **Invalid build context** → "Build context not found: {path}"
4. **Build failure** → Show Docker error output with context
5. **Missing secrets** → "Missing secrets: kv://secret-name. Update ~/.aifabrix/secrets.yaml"

## Testing Strategy

1. **Unit Tests** - Individual functions in isolation
2. **Integration Tests** - Full build flow with mocked Docker
3. **Manual Testing** - Test with real Miso Controller app at C:\git\esystemsdev\aifabrix-miso
4. **Edge Cases** - Missing files, invalid configs, Docker errors

### To-dos

- [ ] Implement helper functions: loadVariablesYaml, resolveContextPath, executeDockerBuild
- [ ] Implement detectLanguage() function with package.json and requirements.txt detection
- [ ] Implement generateDockerfile() with Handlebars template compilation
- [ ] Implement buildApp() main function with complete build workflow
- [ ] Enable build command in CLI by uncommenting and wiring up in lib/cli.js
- [ ] Write comprehensive unit tests for all build functions
- [ ] Write integration tests for full build workflow
- [ ] Run linting, tests, and validate code quality standards (≤500 lines, ≤50 lines per function)
- [ ] Test build command manually with Miso Controller example application