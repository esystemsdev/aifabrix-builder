# Configuration Reference

Simple reference for all configuration files.

## variables.yaml

Generated by `aifabrix create`. Defines your application.

### Required Fields

**app.key**  
Unique identifier (lowercase, dashes only)  
Example: `myapp`, `my-api`, `data-processor`

**app.displayName**  
Human-readable name shown in UIs  
Example: `"My Application"`, `"Data Processor API"`

**app.description**  
What your app does  
Example: `"Processes customer data and generates reports"`

**app.type**  
Application type for Azure  
Options: `webapp`, `api`, `service`, `functionapp`

**port**  
Container internal port  
Example: `3000`, `8080`, `5000`

**image.name**  
Docker image name  
Example: `myapp`, `my-company/myapp`

**image.registry**  
Container registry URL  
Example: `myacr.azurecr.io`, `docker.io`

**image.registryMode**  
Registry type  
Options: `acr`, `external`, `public`

**build.language**  
Runtime language  
Options: `typescript`, `python`

### Optional Fields

**build.localPort**  
Port for local development (if different from container port)  
Example: `3001`

**build.dockerfile**  
Custom Dockerfile path  
Example: `Dockerfile`, `custom/Dockerfile.prod`  
*Leave empty to auto-generate*

**build.context**  
Docker build context  
Default: `.` (current directory)

**build.secrets**  
Path to secrets file  
Default: `~/.aifabrix/secrets.yaml`  
Example: `../../secrets.local.yaml`

**build.envOutputPath**  
Where to copy `.env` file  
Example: `../.env`, `../src/.env`

**requires.database**  
Set `true` if you need database  
Generates database config in env.template

**requires.databases**  
List of database names  
Example:
```yaml
databases:
  - name: myapp
  - name: myapp-analytics
```

**requires.redis**  
Set `true` if you need Redis  
Generates Redis config in env.template

**requires.storage**  
Set `true` if you need file storage  
Mounts `/mnt/data` in container

### Full Example

```yaml
app:
  key: myapp
  displayName: "My Application"
  description: "Does amazing things"
  type: webapp

image:
  name: myapp
  registry: myacr.azurecr.io
  registryMode: acr

port: 3000

requires:
  database: true
  databases:
    - name: myapp
    - name: myapp-logs
  redis: true
  storage: false

build:
  language: typescript
  localPort: 3001
  dockerfile: ""  # Auto-generate
  context: .
  secrets: "../../secrets.local.yaml"
  envOutputPath: ../.env

healthCheck:
  path: /health
  interval: 30

authentication:
  type: keycloak
  enableSSO: true
  requiredRoles: ["user"]
```

---

## env.template

Environment variables template. SDK generates `.env` from this + secrets.

### Standard Variables (Auto-added)

If `requires.database: true`:
```bash
DATABASE_URL=kv://databases-0-urlKeyVault
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=pgadmin
DATABASE_PASSWORD=kv://postgres-passwordKeyVault
DATABASE_NAME=myapp
```

If `requires.redis: true`:
```bash
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=
```

### Your Variables

Add whatever your app needs:
```bash
NODE_ENV=development
PORT=3000
LOG_LEVEL=debug

# API Keys (use kv:// for secrets)
API_KEY=kv://my-api-keyKeyVault
OPENAI_API_KEY=kv://openai-keyKeyVault

# Feature Flags
ENABLE_ANALYTICS=true
ENABLE_CACHE=true

# External Services
PAYMENT_API_URL=https://api.payment.com
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
```

### kv:// References

`kv://name` means "get value from secrets file"

**Secrets file location:**
- Default: `~/.aifabrix/secrets.yaml`
- Override: Set `build.secrets` in variables.yaml

**Example secrets.yaml:**
```yaml
my-api-keyKeyVault: "sk-1234567890abcdef"
openai-keyKeyVault: "sk-proj-xyz..."
postgres-passwordKeyVault: "admin123"
```

**Resolution:**
```bash
# Before (env.template)
API_KEY=kv://my-api-keyKeyVault

# After (.env generated)
API_KEY=sk-1234567890abcdef
```

### Existing .env Files

Have an existing `.env`? 

`aifabrix create` reads it and converts to template:
- Regular values stay as-is
- Sensitive values (passwords, keys) → `kv://` references

---

## rbac.yaml

Roles and permissions. Only created if `authentication: true` during `aifabrix create`.

### Structure

```yaml
roles:
  - name: "User"              # Display name
    value: "user"             # Code identifier (lowercase, dashes)
    description: "Basic user access"
  
  - name: "Admin"
    value: "admin"
    description: "Administrator access"

permissions:
  - name: "app:read"          # Permission identifier
    roles: ["user", "admin"]  # Roles that have this permission
    description: "Read access to application"
  
  - name: "app:write"
    roles: ["admin"]          # Only admins can write
    description: "Write access to application"
```

### Role Naming

**name** - Human-readable, shown in UIs  
Example: `"Platform Administrator"`, `"Content Editor"`

**value** - Code identifier, used in JWT tokens  
Example: `platform-admin`, `content-editor`  
Pattern: lowercase, dashes only

### Permission Naming

Pattern: `resource:action` or `feature:action`

**Examples:**
- `documents:read`
- `documents:write`
- `users:manage`
- `reports:export`
- `settings:admin`

### Why rbac.yaml?

- **Contract with miso-controller** - Defines what roles/permissions your app has
- **Configuration-driven** - No need to hardcode roles in your application
- **Audit trail** - miso-controller tracks all access decisions
- **Centralized management** - Update roles without code changes

---

## Authentication & Access Control

Authentication and access rights are implemented using **miso-client** libraries with **1-2ms response times** thanks to Redis caching.

### Installation

**JavaScript/TypeScript:**
```bash
npm install @aifabrix/miso-client
```

**Python:**
```bash
pip install aifabrix-miso-client
```

### Basic Usage

**JavaScript/TypeScript:**
```typescript
import { MisoClient } from '@aifabrix/miso-client';

const client = new MisoClient({
  controllerUrl: process.env.MISO_CONTROLLER_URL,
  environment: process.env.MISO_ENVIRONMENT, // dev or 'tst', 'pro'
  applicationKey: process.APPLICATION_KEY
});

await client.initialize();

// Access control (1-2ms response from Redis cache)
if (await client.hasRole(userToken, 'admin')) {
  // Admin-only functionality
}

// Check specific permissions
if (await client.hasRole(userToken,'documents:write')) {
  // Can write documents
}
```

**Python:**
```python
from aifabrix_miso_client import MisoClient

client = MisoClient(
    controller_url=os.getenv('MISO_CONTROLLER_URL'),
    environment=os.getenv('MISO_ENVIRONMENT'),  # 'dev', 'tst', or 'pro'
    application_key=os.getenv('APPLICATION_KEY')
)

await client.initialize()

# Access control (1-2ms response from Redis cache)
if await client.has_role(user_token, 'admin'):
    # Admin-only functionality

# Check specific permissions
if await client.has_permission(user_token, 'documents:write'):
    # Can write documents
```

### Error Handling

**JavaScript/TypeScript:**
```typescript
try {
  const isValid = await client.validateToken(token);
  if (!isValid) {
    throw new Error('Invalid token');
  }

  const user = await client.getUser(token);
  
  // Log successful authentication
  await client.log.audit('user.login', 'authentication', {
    userId: user.id,
    ip: '192.168.1.1',
    userAgent: 'Mozilla/5.0...'
  });
  
  // ... use user data
} catch (error) {
  // Log the error
  await client.log.error('Authentication failed', {
    error: error instanceof Error ? error.message : 'Unknown error',
    token: token.substring(0, 10) + '...' // Log partial token for debugging
  });

  // Handle the error appropriately
  console.error('Authentication error:', error);
}
```

**Python:**
```python
try:
    is_valid = await client.validate_token(token)
    if not is_valid:
        raise ValueError('Invalid token')

    user = await client.get_user(token)
    
    # Log successful authentication
    await client.log.audit('user.login', 'authentication', {
        'userId': user.id,
        'ip': '192.168.1.1',
        'userAgent': 'Mozilla/5.0...'
    })
    
    # ... use user data
except Exception as e:
    # Log the error
    await client.log.error('Authentication failed', {
        'error': str(e),
        'token': token[:10] + '...'  # Log partial token for debugging
    })
    
    # Handle the error appropriately
    print(f'Authentication error: {e}')
```

### Audit Trail

All authentication and authorization decisions are automatically logged by miso-controller:

- **Login attempts** - Success/failure with timestamps
- **Permission checks** - What was requested, by whom, when
- **Role changes** - Who granted/revoked roles
- **Failed access** - Security events for monitoring

**View audit logs:**
```bash
# Via miso-controller API
curl https://controller.aifabrix.ai/api/audit/logs?app=myapp
```

### Environment Variables

Add to your `env.template`:
```bash
# Miso Controller connection
MISO_CONTROLLER_URL=https://controller.aifabrix.ai
MISO_ENVIRONMENT=dev  # or 'tst', 'pro'
APPLICATION_KEY=myapp

# Optional: Redis configuration for caching
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# Optional: Logging level
MISO_LOG_LEVEL=info
```

### Benefits

- **Fast responses** - 1-2ms from Redis cache
- **No ISO 27001 coding** - Compliance handled by miso-client
- **Automatic audit** - All decisions logged
- **Centralized security** - miso-controller manages everything
- **Simple integration** - Just install and use

→ [Miso Client Documentation](https://github.com/esystemsdev/aifabrix-miso-client)

---

## Common Patterns

### Multi-Database App
```yaml
requires:
  database: true
  databases:
    - name: myapp          # Primary database
    - name: myapp-analytics # Analytics database
    - name: myapp-logs     # Logs database
```

### Microservice
```yaml
app:
  type: service  # Not exposed via web UI
port: 8080
requires:
  redis: true    # For job queue
```

### Static Site / SPA
```yaml
app:
  type: webapp
port: 80
requires:
  database: false
  redis: false
build:
  language: typescript  # For build process
```

### Background Worker
```yaml
app:
  type: service
port: 3000  # Health check endpoint
requires:
  database: true
  redis: true  # Job queue
```

---

## Validation

SDK validates configuration:

```bash
aifabrix doctor
```

**Checks:**
- Required fields present
- Valid port numbers (1-65535)
- Valid app.key format (lowercase, dashes)
- Database names valid (lowercase, underscores)
- Language is typescript or python
- Registry mode is acr, external, or public

**Example errors:**
```
❌ variables.yaml: Missing required field 'app.key'
❌ variables.yaml: Port must be between 1 and 65535 (found: 99999)
❌ variables.yaml: app.key must be lowercase with dashes (found: 'MyApp')
❌ env.template: Invalid kv:// reference 'kv://missing-key' not in secrets
```

